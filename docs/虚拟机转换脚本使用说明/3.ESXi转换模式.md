**目录**

[TOC]

通过访问ESXi服务器来转换虚拟机。

尽量使用ova或vmx的输入方式，因为它们比本篇的方法更快且需要的空间也更少。

**注意**：此方式要求**转换服务器**和**目标存储域**都有充足的空间来转换虚拟机，否则会转换失败。

# 1. 构造URI

在转换时需要一个URI链接来访问ESXi服务器。

一般的URI格式如下：

```shell
esx://user@esxi.example.com?no_verify=1
```

- `esx`：固定参数，表示这是一个ESXi类型的链接
- `user`：登录到ESXi服务器的用户名
- `esxi.example.com`：ESXi服务器的IP地址或域名
- `?no_verify=1`：用于取消TLS证书检查。

# 2. 测试libvirt到ESXi hypervisor的连接

在转换之前，首先确保该URI是有效的，使用`virsh`命令测试：

```shell
 $ virsh -c esx://root@esxi.example.com?no_verify=1 list --all
 Enter root's password for esxi.example.com: ***
  Id    Name                           State
 ----------------------------------------------------
  -     guest                          shut off
```

如果能看到虚拟机列表则表示该URI可用。

**`警告`**：如果测试失败，那么虚拟机转换不会成功！

# 3. 构造输入选项

在ESXi模式的转换方式下，转换脚本的输入选项有以下几个：

- `--mode`：转换模式。此处为ESXi。
- `--uri`：连接到ESXi服务器的远程链接。
- `--vm-name`：要转换的虚拟机名字。此虚拟机必须在测试URI连接结果的虚拟机列表中。
- `--password-file`：存放登录到ESXi服务器密码的文件。文件中的密码必须是完整的密码且不能跟随任何换行符。可选选项，如果不指定在转换时需要手动输入密码三次，指定需要输入两次。

#### 举例说明：

现在有一台ESXi服务器，其IP地址为`172.16.2.179`，上面有一台虚拟机`centos-esxi-1`，登录密码存在`esxi.pass`文件中。

那么其URI：

```shell
esx://root@172.16.2.179?no_verify=1
```

然后在转换服务器上进行连接测试：

```shell
$ virsh -c 'esx://root@172.16.2.179?no_verify=1' list --all
Enter root's password for 172.16.2.179:
 Id    Name                           State
----------------------------------------------------
 -     centos-esxi-1                  shut off
```

测试成功，输入选项构造如下：

```shell
--mode ESXi --uri esx://root@172.16.2.179?no_verify=1 --vm-name centos-esxi-1 --password-file esxi.pass
```

# 4. 转换到ovirt平台

参考：[转换到ovirt平台](转换到ovirt平台.md)

