**目录**

[TOC]

通过VMware的开发库vddk（Virtual Disk Development Kit）进行虚拟机转换。

**注意：此库是非开源的，不允许重新分发或商业用途，慎用。**

# 1. 获取vddk

获取vddk的两种方式：

- 在VMware官网下载linux版本的vddk（后缀名是*.tar.gz*），下载地址：[开发库](https://code.vmware.com/web/sdk/6.7/vddk)。
- 在`resources`文件下的获取下载好的开发库`VMware-vix-disklib-6.7.0-8173251.x86_64.tar.gz`。

将vddk放到`转换服务器中`，然后解压即可：

```shell
tar -xvf VMware-vix-disklib-6.7.0-8173251.x86_64.tar.gz
```

# 2. 构造URI

此种转换模式在vCenter与ESXi服务器上面使用。提供的URI连接也是这两种形式的。

- 构造ESXi服务器的URI链接参考[ESXi转换模式](3.ESXi转换模式.md)的`构造URI`章节。

- 构造vCenter服务器的URI链接参考[vCenter转换模式](4.vCenter转换模式.md)的`构造URI`章节。

# 3. 测试libvirt到vCenter的连接

在转换之前，首先确保该URI是有效的，

- 对于ESXi服务器的URI链接验证参考[ESXi转换模式](3.ESXi转换模式.md)的`测试libvirt到ESXi hypervisor的连接`章节。
- 对于vCenter服务器的URI链接验证参考[vCenter转换模式](4.vCenter转换模式.md)的`测试libvirt到vCenter的连接`章节。

# 4. 构造输入选项

vddk的输入选项是基于ESXi转换模式或vCenter转换模式构造的，在它们的基础上增加输入选项。故先参考它们的输入选项的构造，再做修改。

vddk模式的输入选项除了上述的几个之外，还需要以下两个参数：

- `--vddk-libdir`：vddk开发库在转换服务器上的路径。这个路径就是第一步中开发库解压之后的文件夹所在路径。只能用于vddk模式。
- `--vddk-thumbprint`：ESXi服务器或vCenter服务器的指纹。只能用于vddk模式。

ESXi服务器指纹的获取：

通过`ssh`登录到ESXi服务器（需要打开SSH功能），执行命令：

```shell
openssl x509 -in /etc/vmware/ssl/rui.crt -fingerprint -sha1 -noout
```

vCenter服务器指纹的获取：

通过`ssh`以`root`身份登录到vCenter服务器，执行命令：

```bash
Command> shell
openssl x509 -in /etc/vmware-vpx/ssl/rui.crt -fingerprint -sha1 -noout
```

输出`SHA1 Fingerprint=xxx`，`xxx`即是服务器的指纹。

最后，还需要修改一下`--mode`选项为`vddk`。

最终完整的输入选项格式就是：

```shell
--mode vddk --uri esx://root@172.16.2.179?no_verify=1 --vm-name centos-esxi-1 --password-file esxi.pass --vddk-libdir vmware-vix-disklib-distrib --vddk-thumbprint xxx
```

或

```shell
--mode vddk --uri vpx://administrator%40vsphere.local@172.16.2.178/Datacenter-test/cluster-test/172.16.2.179?no_verify=1 --vm-name centos-esxi-1 --password-file vcenter.pass --vddk-libdir vmware-vix-disklib-distrib --vddk-thumbprint xxx
```



# 5. 转换到ovirt平台

参考：[转换到ovirt平台](转换到ovirt平台.md)

