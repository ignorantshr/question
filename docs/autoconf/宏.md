*tag*：引用变量：如果是宏赋值的变量，则可直接`$xxx`，如果是shell变量则需要`${xxx}`。如果赋值与引用都在一段shell脚本里面，那么可直接引用`$xxx`。
#### AC_INIT *(package, version, [bug-report], [tarname], [url])*
第一个要执行的宏。设置程序名、版本号、联系方式...。他们都应该是静态的参数，不能是shell参数、引用或者新行，但是可以通过m4计算出来。
```autoconf
AC_INIT([vdsm],
        [m4_esyscmd([build-aux/pkg-version --version])],
        [vdsm-devel@lists.fedorahosted.org])
```

#### AC_CONFIG_AUX_DIR *(dir)*
辅助构建工具（e.g., install-sh, config.sub, config.guess, Cygnus configure, Automake and Libtool scripts, etc.）所在的目录。*dir*可以是*srcdir*的绝对或相对路径，通常命名为`build-aux`。
```autoconf
AC_CONFIG_AUX_DIR([build-aux])
```

#### m4_include *(file)*
跟m4内置的宏类似
```autoconf
m4_include([m4/ax_python_module.m4])
```

#### AC_SUBST *(variable, [value])*
从shell变量创建输出变量。使`AC_OUTPUT`替换变量*variable*的值到输出文件中（一般是Makefile文件）。意思就是`AC_OUTPUT`使用shell变量*variable*的值替换输入文件（Makefile.in）的*@variable@*到输出文件（Makefile）。如果值是新行，考虑使用`AM_SUBST_NOTMAKE`防止automake添加 *variable = @variable@* 到Makefile.in文件。
```autoconf
AC_SUBST([PACKAGE_RELEASE],
         [m4_esyscmd([build-aux/pkg-version --release])])
```
configure对应的语句
```
PACKAGE_RELEASE=44.gitb50346e
```

#### AS_IF *(test1, [run-if-true1], ..., [run-if-false])*
if else语句。执行shell代码。
```
AS_IF([test "${enable_hooks}" = "yes"],
      AC_SUBST([HOOKS], ['1']),
      AC_SUBST([HOOKS], ['0']))
```
configure对应的语句
```
if test "${enable_hooks}" = "yes"; then :
  HOOKS='1'

else
  HOOKS='0'

fi
```

#### AC_PROG_LN_S
如果当前文件系统支持`ln -s`，设置输出变量*LN_S*为`ln -s`；否则，如果支持`ln`，设置*LN_S*为`ln`，否则设置为`cp -pR`。
```
AC_PROG_LN_S
```

#### AC_ARG_ENABLE *(feature, help-string, [action-if-given], [action-if-not-given])*
如果用户给了configure选项`--enable-feature`或`--disable-feature`，执行shell命令*action-if-given*；如果没有给出选项，执行*action-if-not-given*。*feature*应该只由字母、破折号、加号、点组成。

选项的参数可以获取，其命名方式为`with_feature`，其中所有的非字母符号都用`_`代替。

*help-string*类似于`AC_ARG_WITH`；你应该使用*AS_HELP_STRING*格式化*help-string*。
```
AC_ARG_ENABLE(
    [hooks],
    [AS_HELP_STRING(
        [--enable-hooks],
        [build hooks packages @<:@default=no@:>@]
    )],
    ,
    [enable_hooks="no"]
)

效果：
~$ ./configure --help
--enable-hooks          build hooks packages [default=no]
```
configure对应的语句
```
# Check whether --enable-hooks was given.
if test "${enable_hooks+set}" = set; then :
  enableval=$enable_hooks;
else
  enable_hooks="no"

fi
```

#### AS_HELP_STRING *(left-hand-side, right-hand-side [indent-column = ‘26’], [wrap-column = ‘79’])*
格式化帮助文档，使其看起来跟官方的一样。
```
AC_ARG_WITH([foo],
    [AS_HELP_STRING([--with-foo],
       [use foo (default is no)])],
    [use_foo=$withval],
    [use_foo=no])

Then the last few lines of ‘configure --help’ appear like this:

	--enable and --with options recognized:
	--with-foo              use foo (default is no)
```
通常*indent-column*和*wrap-column*不必指定。

#### AC_ARG_WITH *(package, help-string, [action-if-given], [action-if-not-given])*
如果用户运行configure的时候给了选项`--with-package 或 --without-package`，运行shell命令*action-if-given*，没有则运行*action-if-not-given*。*package*应该只由字母、破折号、加号、点组成。

选项的参数可以通过shell变量`${withval}`获取，其值的命名为`with_package`，其中所有的非字母符号都用`_`代替。
```
AC_ARG_WITH(
    [smbios-manufacturer],
    [AS_HELP_STRING([--with-smbios-manufacturer=NAME],
                    [SMBIOS manufacturer name @<:@default=oVirt@:>@])],
    [SMBIOS_MANUFACTURER="${withval}"],
    [SMBIOS_MANUFACTURER="oVirt"])
AC_SUBST([SMBIOS_MANUFACTURER]) # 一定要注册一下，暂时不知道为什么
```
configure对应的语句
```
# Check whether --with-smbios-manufacturer was given.
if test "${with_smbios_manufacturer+set}" = set; then :
  withval=$with_smbios_manufacturer; SMBIOS_MANUFACTURER="${withval}"
else
  SMBIOS_MANUFACTURER="oVirt"
fi
```

#### AC_PATH_PROGS *(variable, progs-to-check-for, [value-if-not-found], [path = ‘$PATH’])*
检查命令是否安装。类似于`AC_CHECK_PROG`，检查*path*中是否存在*progs-to-check-for*。区别在于总是设置*variable*=*progs-to-check-for*的绝对路径。

该测试结果可以通过对*variable*赋值的方式改变。

测试结果被缓存在*ac_cv_path_variable*变量中。
```
AC_PATH_PROG([PYFLAKES], [pyflakes])
```
configure对应的语句
```
# Extract the first word of "pyflakes", so it can be a program name with args.
set dummy pyflakes; ac_word=$2
{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
$as_echo_n "checking for $ac_word... " >&6; }
if ${ac_cv_path_PYFLAKES+:} false; then :
  $as_echo_n "(cached) " >&6
else
  case $PYFLAKES in
  [\\/]* | ?:[\\/]*)
  ac_cv_path_PYFLAKES="$PYFLAKES" # Let the user override the test with a path.
  ;;
  *)
  as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
for as_dir in $PATH
do
  IFS=$as_save_IFS
  test -z "$as_dir" && as_dir=.
    for ac_exec_ext in '' $ac_executable_extensions; do
  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
    ac_cv_path_PYFLAKES="$as_dir/$ac_word$ac_exec_ext"
    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
    break 2
  fi
done
  done
IFS=$as_save_IFS

  ;;
esac
fi
PYFLAKES=$ac_cv_path_PYFLAKES
if test -n "$PYFLAKES"; then
  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $PYFLAKES" >&5
$as_echo "$PYFLAKES" >&6; }
else
  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
$as_echo "no" >&6; }
fi
```

#### AC_CHECK_PROG *(variable, prog-to-check-for, value-if-found, [value-if-not-found], [path = ‘$PATH’], [reject])*
检查*path*中是否存才*prog-to-check-for*。*variable*=if 存在 ? *value-if-found*: *value-if-not-found*。总是忽视*reject*（一个文件名的绝对路径），在这种情况下，*variable*=*prog-to-check-for*的绝对路径。

调用`AC_SUBST`赋值。

测试结果可以通过设置*variable*或者*ac_cv_prog_variable*的值来覆盖。

#### AC_DEFUN *(name, [body])*
将自己的宏定义写在.m4文件中，可在configure.ac文件中调用。
```
AC_DEFUN([AX_PYTHON_MODULE],[
	shell脚本
])
```

#### AC_REQUIRE *(macro-name)*
自动地解决宏调用之间的依赖关系，保证一个宏在满足条件的情况下才会被调用，且只调用一次。只能出现在`AC_DEFUN`。
？？？

#### AU_ALIAS *(old-name, new-name)*
宏的重命名。
```
AU_ALIAS([AC_PYTHON_MODULE], [AX_PYTHON_MODULE])
```

#### AC_OUTPUT *([file]..., [extra-cmds], [init-cmds])*
不推荐使用这个废弃的接口，用以下三个宏代替：

          AC_CONFIG_FILES(file...)
          AC_CONFIG_COMMANDS([default],
                             extra-cmds, init-cmds)
          AC_OUTPUT


#### AC_OUTPUT
生成config.status并启动它。configure.ac应该以调用此宏结束。
config.status执行所有的配置动作：所有的输出文件、头文件、命令、链接、要配置的子目录

## 执行配置动作
configure实际上还有一个隐藏的子文件config.status。configure检查系统，config.status基于检查的结果执行相应的操作。

#### AC_CONFIG_FILES *(file..., [cmds], [init-cmds])*
让`AC_OUTPUT`通过复制输入文件（默认是*file.in*文件）并代替里面的变量的值来创建每一个*file*。通常用于生成Makefile，但也可以指定其它文件。

          AC_CONFIG_FILES([Makefile src/Makefile man/Makefile X/Imakefile])
          AC_CONFIG_FILES([autoconf], [chmod +x autoconf])

冒号分隔指定输入文件：
	
          AC_CONFIG_FILES([Makefile:boiler/top.mk:boiler/bot.mk]
                          [lib/Makefile:boiler/lib.mk])

#### AC_CONFIG_HEADERS *(header ..., [cmds], [init-cmds])*
让`AC_OUTPUT`创建一个头文件，该文件列出一系列的`#define`声明；赋值`DEFS=-DHAVE_CONFIG_H`。通常头文件*header*的名字是*config.h*。

一般输入源是`header.in`，可以采用冒号分隔符来指定输入来源。
```
AC_CONFIG_HEADERS([config.h:config.hin])
```

#### AC_CONFIG_COMMANDS *(tag..., [cmds], [init-cmds])*
config.status结束的时候执行额外的命令。

#### AC_CONFIG_COMMANDS_PRE *(cmds)*
创建config.status之前执行。

#### AC_CONFIG_COMMANDS_POST *(cmds)*
创建config.status之后执行。

## Printing Messages
输出信息

#### AC_MSG_CHECKING *(feature-description)*
提示用户configure正在检查一个特定的功能。必须后跟`AC_MSG_RESULT`打印检查结果和换行。`--quiet`和`--silent`选项不会打印。
```
AC_MSG_CHECKING($PYTHON_NAME module: $1)
"$THIS_MODULE_PYTHON" -c "import $1" 2>/dev/null
if test $? -eq 0;
then
    AC_MSG_RESULT(yes)
else
    AC_MSG_RESULT(no)
```

#### AC_MSG_RESULT *(result-description)*
提示用户检查的结果，*result-description*一般是*‘yes’, ‘no’, or a file name*。

#### AC_MSG_WARN *(problem-description)*
发出警告，打印信息到标准错误输出。
```
AC_MSG_WARN([pyflakes not found])
```

#### AC_MSG_ERROR *(error-description, [exit-status = ‘$?/1’])*
提示一个错误，终止configure。*$?*是默认的，除非0变为了1。**???**

## M4sh macros
M4sh的目的是生成可移植的shell脚本，其宏名以`AS_`开头。

### 普通的shell构造
#### AS_TR_CPP *(expression)*
将*expression*转为C的宏定义
```
AS_TR_CPP(HAVE_PYMOD_$1) #This outputs "#define HAVE_PYMOD_$1".
```
## 编译器和执行器

### C编译器特性
#### AC_PROG_CC *([compiler-search-list])*
指定一个C编译器，如果`CC`没有在环境中设置，那么检查`gcc and cc`，然后是其它的C编译器。设置找到的编译器给变量`CC`。