<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="shihr">
    
    <link rel="shortcut icon" href="../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>8.使用M4编程 - Sink</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "8.1 M4 \u7684\u5f15\u7528", url: "#_top", children: [
              {title: "8.1.3 \u5f15\u7528\u548c\u53c2\u6570", url: "#813" },
              {title: "8.1.6 \u7279\u6b8a\u5b57\u7b26\u66ff\u6362", url: "#816" },
          ]},
          {title: "8.2 \u4f7f\u7528 autom4te", url: "#82-autom4te", children: [
          ]},
          {title: "8.3 \u4f7f\u7528 M4 \u7684\u8bed\u6cd5", url: "#83-m4", children: [
              {title: "8.3.1 \u91cd\u5b9a\u4e49M4\u5b8f", url: "#831-m4" },
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../9.使用M4sh编程/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../9.使用M4sh编程/" class="btn btn-xs btn-link">
        9.使用M4sh编程
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../7.测试结果/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../7.测试结果/" class="btn btn-xs btn-link">
        7.测试结果
      </a>
    </div>
    
  </div>

    

    <p>Autoconf在两个层面上编写：1、M4sugar，提供比纯M4编程更加方便的宏；2、M4sh，提供专用于生成shell脚本的宏。</p>
<h2 id="81-m4">8.1 M4 的引用</h2>
<p>Autoconf的使用者可以跳过这一部分，宏编写者必须阅读。<a href="https://www.gnu.org/software/autoconf/manual/autoconf.html#M4-Quotation">M4 Qutation</a>。</p>
<p>每次宏展开时，都会去除一层引用。</p>
<h3 id="813">8.1.3 引用和参数</h3>
<p>在M4的一个宏定义中，遇到了<code>$(‘0’...‘9’, ‘#’, ‘@’, or ‘*’)</code>，会执行M4的参数展开。不管有多少层嵌套引用，甚至是注释都会执行。</p>
<pre><code> define([none], [$1]) #会导致扩展
 ⇒
 define([one], [[$1]]) #当作文本处理
 ⇒
 define([two], [[[$1]]]) #当作[文本]处理
 ⇒
 define([comment], [# $1]) #注释
 ⇒
 define([active], [ACTIVE])
 ⇒
 none([active])
 ⇒ACTIVE
 one([active])
 ⇒active
 two([active])
 ⇒[active]
 comment([active])
 ⇒# active
</code></pre>
<p>想要打破这一规则需要这样使用：</p>
<pre><code> define([single], [a single-quoted $[]1 definition])
 ⇒
 define([double], [[a double-quoted $][1 definition]])
 ⇒
 single
 ⇒a single-quoted $1 definition
 double
 ⇒a double-quoted $1 definition
</code></pre>
<p><strong>warning</strong>：M4扩展一个宏之后，结果文本会被立即进行宏扩展和引用删除。例：</p>
<pre><code> car([int tab[10];])
 ⇒int tab10;
 car([[int tab[10];]])
 ⇒int tab[10];
</code></pre>
<p>第一个扩展的结果是<code>int tab[10];</code>，但是经过引用删除之后，去除了引用符号；<br>
第二个扩展的结果是<code>[int tab[10];]</code>，经过引用删除之后，还会保留内部的引用符号。</p>
<h3 id="816">8.1.6 特殊字符替换</h3>
<p>编写Autoconf宏的时候可能需要特殊字符，但是使用标准的引用规则会很困难。</p>
<p>还有，少量的M4sugar内部使用了特殊字符，如果宏参包含了<code>-=&lt;{(</code> or <code>)}&gt;=-</code>，它们可能不会正常工作。</p>
<p>替换规则：</p>
<ul>
<li>@&lt;:@ - [</li>
<li>@:&gt;@ - ]</li>
<li>@S|@ - $</li>
<li>@%:@ - #</li>
<li>@{:@ - (</li>
<li>@:}@ - )</li>
<li>@&amp;t@ - Expands to nothing</li>
</ul>
<pre><code>AC_ARG_ENABLE(
    [ovirt-vmconsole],
    [AS_HELP_STRING(
        [--disable-ovirt-vmconsole],
        [disable ovirt-vmconsole integration @&lt;:@default=no@:&gt;@]
    )],
    ,
    [enable_ovirt_vmconsole=&quot;yes&quot;]
)
</code></pre>

<h2 id="82-autom4te">8.2 使用 autom4te</h2>
<p>除了Autoconf本身，Autoconf套件包括M4sugar, M4sh, and Autotest，很大程度上依赖M4。</p>
<h2 id="83-m4">8.3 使用 M4 的语法</h2>
<p>保留了<code>m4_</code>开头的宏命名空间。</p>
<h3 id="831-m4">8.3.1 重定义M4宏</h3>
<p>除了几个例外，所有的M4本地宏都被重命名为<code>m4_</code>开头。
下面这些宏没有改变：</p>
<pre><code>m4_builtin
m4_changecom
m4_changequote
m4_debugfile
m4_debugmode
m4_decr
m4_define
m4_divnum
m4_errprint
m4_esyscmd
m4_eval
m4_format
m4_ifdef
m4_incr
m4_index
m4_indir
m4_len
m4_pushdef
m4_shift
m4_substr
m4_syscmd
m4_sysval
m4_traceoff
m4_traceon
m4_translit
</code></pre>
<p>下面的有轻微的不同：</p>
<h4 id="m4_include-file">m4_include <em>(file)</em></h4>
<h4 id="m4_sinclude-file">m4_sinclude <em>(file)</em></h4>
<p>跟m4内置的宏类似，但是会对多次引入文件发出警告。</p>
<pre><code class="autoconf">m4_include([m4/ax_python_module.m4])
</code></pre>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../9.使用M4sh编程/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../9.使用M4sh编程/" class="btn btn-xs btn-link">
        9.使用M4sh编程
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../7.测试结果/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../7.测试结果/" class="btn btn-xs btn-link">
        7.测试结果
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content">
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>