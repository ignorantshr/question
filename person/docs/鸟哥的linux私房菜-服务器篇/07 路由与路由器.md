## 路由

### 路由表产生的类型

每一部主机都有自己的路由表：

```bash
root@sink:~# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.1.1     0.0.0.0         UG    600    0        0 wlan0
172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0
192.168.1.0     0.0.0.0         255.255.255.0   U     600    0        0 wlan0
```

- 依据网络接口产生的 IP 而存在的路由

    例如 192.168.1.0/24 这个路由的存在是由于鸟哥的这部主机上面拥有 192.168.1.112 这个 IP 的关系。

- 手动或预设路由(default route)

    你可以使用`route`这个指令手动的给予额外的路由设定，预设路由 (0.0.0.0/0) 就是额外的路由。使用该指令时，**你所规划的路由必须要是你的设备(如 eth0) 或 IP 可以直接沟通 (broadcast) 的情况**。

```bash
root@sink:~# route add -net 192.168.2.0 netmask 255.255.255.0 gw 192.168.2.254
SIOCADDRT: 网络不可达    
```

如果 192.168.2.254 真的是在我们的实体网络连接上，并且与我们的 wlan0 连接在一起，那其实你应该是这样做：

```bash
root@sink:~# route add -net 192.168.2.0 netmask 255.255.255.0 dev wlan0
root@sink:~# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.1.1     0.0.0.0         UG    600    0        0 wlan0
172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0
192.168.1.0     0.0.0.0         255.255.255.0   U     600    0        0 wlan0
192.168.2.0     0.0.0.0         255.255.255.0   U     0      0        0 wlan0
```

- 动态路由

    除了使用指令来增加路由规则之外，还有一种透过路由器与路由器之间的协商以达成动态路由的环境，不过，那就需要额外的软件支持了。`zebra`或centos的`Quagga`。

事实上，在 Linux 的路由规则都是透过内核来达成的，所以这些路由表的规则都是在内存中。

### 一个网卡绑多个 IP（IP Alias）

`eth0:0`这个装置可以在原本的 eth0 上面模拟出一个虚拟接口出来，以让我们原本的网络卡具有多个 IP，具有多个 IP 的功能就被称为`IP Alias`。

```
root@sink:~# ip a add 172.16.1.1/24 label wlan0:v0 br + dev wlan0
root@sink:~# ip a show wlan0
3: wlan0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether 74:29:af:09:69:d5 brd ff:ff:ff:ff:ff:ff
    inet 192.168.1.112/24 brd 192.168.1.255 scope global dynamic noprefixroute wlan0
       valid_lft 7142sec preferred_lft 7142sec
    inet 172.16.1.1/24 brd 172.16.1.255 scope global wlan0:v0
       valid_lft forever preferred_lft forever
    inet6 fe80::8018:a56a:4c42:f8ec/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever
```

IP Alias 的常见用途：

- 测试用

    建立一个虚拟的网络接口，不会改变你原来的网络参数设定。

- 在一个实体网域中含有多个 IP 网域

- 既有设备无法提供更多实体网卡时

所有的 IP Alias 都是由实体网卡仿真来的，所以当要启动 eth0:0时，eth0 必须要先被启动才行。那么如何在开机的时候就启动 IP Alias 呢：

创建 `/etc/sysconfig/network-scripts/ifcfg-eth0:0` 配置文件即可。

**注意**：不论 ifcfg-eth0:0 内的 ONBOOT 设定值为何，只要 ifcfg-eth0 这个实体网卡的配置文件中， ONBOOT 为 yes 时，开机就会将全部的 eth0:n 都启动。

## 路由器架设

### 路由器

路由器的主要功能就是：**转发网络数据包**。也就是说，`路由器`会分析来源端包的 IP 表头，在表头内找出要送达的目标 IP 后，透过路由器本身的`路由表` (routing table) 来将这个包向下一个目标(next hop) 传送。

路由器的功能分为两种方式来达成：

- 硬件：路由器内有嵌入式的操作系统，可以负责不同网域间的包转译与转递等功能；
- 软件：例如 Linux 这个操作系统的内核就有提供包转递的能力。

#### 使用 Linux 作为路由器

只需要打开路由转发功能就可以了。

##### 打开内核的路由转发（IP Forward）功能

就如同路由表是由 Linux 的内核功能所提供的，这个转发包的能力也是 Linux 内核所提供。

查看是否开启：

```
root@sink:~# cat /proc/sys/net/ipv4/ip_forward
1
```

`1`代表开启，`0`代表关闭。可以直接向此文件写入来临时地开启或关闭该功能。

但是若想改变默认配置则需要修改：

```
root@sink:~# vi /etc/sysctl.conf
……
net.ipv4.ip_forward=1
……

# 立即生效
root@sink:~# sysctl -p
```

打开此功能后就完成路由器的设置啦！下面就是根据实际情况设置路由了。

通常Linux路由器规划其路由表的方式有两种：

- 静态路由：直接以类似 route 这个指令来直接设定路由表到核心功能当中，设定值只要与网域环境相符即可。 不过，当你的网络有变化时，路由器就得要重新设定；
- 动态路由：透过类似 Quagga 或 zebra 软件的功能，这些软件可以安装在 Linux 路由器上，而这些软件可以动态的侦测网络的变化，并直接修改 Linux 核心的路由表信息。

<br/>

了解了路由器之后，接下来你可能需要了解到什么是 NAT (Network Address Translation， 网络地址转换) 服务器。NAT 本身就是一个路由器，只是 NAT 比路由器多了一个`IP 替换`的功能。

- 一般来说，路由器会有两个网络接口，透过路由器本身的 IP 转递功能让两个网域可以互相沟通网络封包。 那如果两个接口一边是公共 IP (public IP) 但一边是私有 IP (private IP)呢? 由于私有 IP 不能直接与公共 IP 沟通其路由信息，此时就得要额外的 `IP 替换`功能了；
- Linux 的 NAT 服务器可以透过修改封包的 IP 表头数据之来源或目标 IP ，让来自私有 IP的封包可以转成 NAT 服务器的公共 IP ，就可以连上 Internet !

### 何时需要路由器

一般来说，计算机数量小于数十部的小型企业是无须路由器的，只需要利用 hub/switch 串接各部计算机，然后透过单一线路连接到 Internet 上即可。

- 实体线路之布线及效能的考虑：

    计算机太多时，使用路由器可以方便管理；架设路由器将实体线路分隔，就有助于这方面的网络效能；

- 部门独立与保护数据的考虑：

    只要实体线路是连接在一起的，那么当数据透过广播时，你就可以透过类似 tcpdump 的指令来监听封包数据；可以将那些重要的计算机放到一个独立的实体网络，并额外加设防火墙、路由器等连接上公司内部的网络。

### Linux 静态路由实操

//TODO

## 动态路由器架设：quagga (zebra + ripd)

//TODO

## 特殊状况：路由器两边是同一个 IP 网段

//TODO