<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="shihr">
    
    <link rel="shortcut icon" href="../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>6.变量 - Sink</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "\u53d8\u91cf\u5f15\u7528\u57fa\u7840", url: "#_top", children: [
          ]},
          {title: "\u53d8\u91cf\u7684\u4e24\u79cd\u7c7b\u578b", url: "#_2", children: [
              {title: "\u8fd8\u6709\u53e6\u4e00\u79cd\u5b9a\u4e49\u64cd\u4f5c?=\uff0c\u6761\u4ef6\u8d4b\u503c\u53d8\u91cf\uff0c\u5982\u679c\u8be5\u53d8\u91cf\u6ca1\u6709\u88ab\u5b9a\u4e49\u8fc7\uff0c\u90a3\u4e48\u624d\u4f1a\u88ab\u8d4b\u503c\u3002", url: "#_3" },
          ]},
          {title: "\u5f15\u7528\u53d8\u91cf\u7684\u9ad8\u7ea7\u7279\u6027", url: "#_4", children: [
              {title: "\u66ff\u6362\u5f15\u7528", url: "#_5" },
              {title: "\u8ba1\u7b97\u53d8\u91cf\u540d", url: "#_6" },
              {title: "\u6267\u884cshell\u811a\u672c", url: "#shell" },
          ]},
          {title: "\u5411\u53d8\u91cf\u6dfb\u52a0\u5185\u5bb9", url: "#_7", children: [
          ]},
          {title: "override\u6307\u4ee4", url: "#override", children: [
          ]},
          {title: "\u5b9a\u4e49\u591a\u884c\u53d8\u91cf", url: "#_8", children: [
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../7.Makefile中的条件语句/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../7.Makefile中的条件语句/" class="btn btn-xs btn-link">
        7.Makefile中的条件语句
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../5.编写recipes/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../5.编写recipes/" class="btn btn-xs btn-link">
        5.编写recipes
      </a>
    </div>
    
  </div>

    

    <ul>
<li>
<p>变量名是大小写敏感的。</p>
</li>
<li>
<p>推荐大写的变量名来控制隐含规则或者用户使用命令行时会覆盖的参数；小写变量名在Makefile内部使用。</p>
</li>
</ul>
<h2 id="_1">变量引用基础</h2>
<p><code>$(xxx)</code>与<code>${xxx}</code>都是可以的。
在文件名或<em>recipe</em>中写入<code>$</code>符号必须键入<code>$$</code>。</p>
<h2 id="_2">变量的两种类型</h2>
<ol>
<li><em>recursively expanded</em>变量。使用<code>=</code>（单行）或<code>define</code>（多行）定义变量。
缺点：<ul>
<li><code>CFLAGS = $(CFLAGS) -O</code></li>
<li>会引起自循环，make会检测到自循环并报告一个错误。</li>
<li>每次变量被扩展的时候任何在定义中的函数<a href="https://www.gnu.org/software/make/manual/make.html#Functions">(see Functions for Transforming Text)</a>引用都会执行。会引起<em>wildcard</em>和<em>shell</em>函数给出不可预知的结果。</li>
</ul>
</li>
<li><em>simply expanded</em>变量，可以解决上述的缺点。使用<code>:=</code>或<code>::=</code>来定义。只有<code>::=</code>被POSIX标准支持。对于所有引用该变量的其它变量或者函数，它只会被扫描一次。
例：</li>
</ol>
<pre><code>x := foo
y := $(x) bar
x := later
</code></pre>

<p>结果：</p>
<pre><code>y := foo bar
x := later
</code></pre>

<p><strong>区别</strong>：make在执行定义<em>recursively expanded variable</em>时，不会扩展该变量中的引用变量，只有在引用该变量的时候引用变量才会被扩展；<em>simply expanded variable</em>则是在定义变量的时候就已经将引用变量扩展了。</p>
<h6 id="_3">还有另一种定义操作<code>?=</code>，条件赋值变量，如果该变量没有被定义过，那么才会被赋值。</h6>
<pre><code>FOO ?= bar
</code></pre>

<p>等于</p>
<pre><code class="makefile">ifeq ($(origin FOO), undefined)
  FOO = bar
endif
</code></pre>

<p><em>note</em>：变量被赋予空值的话，它仍然是被定义了。所以<code>?=</code>不会被设置变量。</p>
<h2 id="_4">引用变量的高级特性</h2>
<h3 id="_5">替换引用</h3>
<p>格式<code>$(var:a=b)</code> (or <code>${var:a=b}</code>)会导致替换掉<em>var</em>的值中用<em>b</em>替换<em>a</em>。</p>
<p>可与<code>patsubst</code>结合使用。</p>
<pre><code class="makefile">foo := a.o b.o c.o
bar := $(foo:%.o=%.c)
</code></pre>

<p>结果：<code>bar = a.c b.c c.c</code></p>
<h3 id="_6">计算变量名</h3>
<p>变量可能被引用在一个变量名中。这叫做<em>computed variable name</em>或<em>nested variable reference</em>。</p>
<p>这种方式的唯一缺点就是不能指定被调用的函数名。？？？</p>
<h3 id="shell">执行shell脚本</h3>
<p><code>!=</code>可用于执行shell脚本并把输出设置为变量的值。</p>
<pre><code class="makefile">hash != printf '\043'
file_list != find . -name '*.c'
</code></pre>

<p>如果结果中含有<code>$</code>，并且不想使其扩展为make变量，那么必须替换为<code>$$</code>。你也可以使用shell函数（<a href="https://www.gnu.org/software/make/manual/make.html#Shell-Function">See The shell Function</a>）。</p>
<pre><code class="makefile">hash := $(shell printf '\043')
var := $(shell find . -name &quot;*.c&quot;)
</code></pre>

<h2 id="_7">向变量添加内容</h2>
<p>向一个已经定义的变量中添加内容：</p>
<pre><code class="makefile">objects = main.o foo.o bar.o utils.o
objects += another.o
</code></pre>

<p>变量没有被定义时，<code>+=</code>相当于<code>=</code>。
如果定义了，取决于变量类型。</p>
<h2 id="override">override指令</h2>
<p>如果使用命令行参数设置了变量，那么在makefile中的设置将被忽略。<code>override</code>可以打破这个规则。</p>
<pre><code class="makefile">override variable = value
</code></pre>

<p>比所有其它方式定义的变量的优先级都要高。</p>
<p>用来提示并添加用户指定的命令行参数：</p>
<pre><code>override CFLAGS += -g
</code></pre>

<p>结合define使用：</p>
<pre><code>override define foo =
bar
endef
</code></pre>

<h2 id="_8">定义多行变量</h2>
<pre><code class="makefile">define two-lines =
echo foo
echo $(bar)
endef
</code></pre>

<p>当在<em>recipe</em>中使用此种变量时，相当于</p>
<pre><code class="makefile">two-lines = echo foo; echo $(bar)
</code></pre>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../7.Makefile中的条件语句/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../7.Makefile中的条件语句/" class="btn btn-xs btn-link">
        7.Makefile中的条件语句
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../5.编写recipes/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../5.编写recipes/" class="btn btn-xs btn-link">
        5.编写recipes
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content">
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>