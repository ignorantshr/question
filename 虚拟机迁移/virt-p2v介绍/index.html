<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="shihr">
    
    <link rel="shortcut icon" href="../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>virt-p2v介绍 - Sink</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "1.\u7f51\u7edc\u8bbe\u7f6e", url: "#_top", children: [
          ]},
          {title: "2.GUI\u4ea4\u4e92\u5f0f\u914d\u7f6e", url: "#2gui", children: [
              {title: "2.1 SSH\u914d\u7f6e", url: "#21-ssh" },
              {title: "2.2 \u78c1\u76d8\u548c\u7f51\u7edc\u914d\u7f6e", url: "#22" },
              {title: "2.3 \u8f6c\u6362\u8fd0\u884c\u754c\u9762", url: "#23" },
          ]},
          {title: "3. \u5185\u6838\u547d\u4ee4\u884c\u914d\u7f6e", url: "#3", children: [
          ]},
          {title: "4.SSH\u8ba4\u8bc1", url: "#4ssh", children: [
          ]},
          {title: "5.\u5de5\u4f5c\u65b9\u5f0f", url: "#5", children: [
          ]},
          {title: "6.\u4f7f\u7528", url: "#6", children: [
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../virt-p2v磁盘转换流程/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../virt-p2v磁盘转换流程/" class="btn btn-xs btn-link">
        virt-p2v磁盘转换流程
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../virt-p2v-make-disk脚本分析/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../virt-p2v-make-disk脚本分析/" class="btn btn-xs btn-link">
        virt-p2v-make-disk脚本分析
      </a>
    </div>
    
  </div>

    

    <p>原文地址：<a href="http://libguestfs.org/virt-p2v.1.html">virt-p2v</a></p>
<p>不要直接运行<code>virt-p2v</code>。你应该使用可启动<code>CDROM,ISO,PXE image</code>来启动物理机。这个映像包括virt-p2v二进制文件，并会自动地运行它。这么做的原因是被磁盘必须是非活动状态，因为其他程序会修改活动磁盘的内容。这个启动映像由<code>virt-p2v-make-disk</code>制作。</p>
<h1 id="1">1.网络设置</h1>
<p><code>virt-p2v</code>在物理机上面运行。它通过<strong>SSH</strong>与转换服务器（安装了<code>virt-v2v</code>）通信。</p>
<pre><code class="shell"> ┌──────────────┐                  ┌─────────────────┐
 │ virt-p2v     │                  │ virt-v2v        │
 │ (physical    │  ssh connection  │ (conversion     │
 │  server)   ╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍▶ server)       │
 └──────────────┘                  └─────────────────┘
</code></pre>

<p><code>virt-v2v</code>执行真正的转换。</p>
<p>SSH连接总是从物理机发起。</p>
<p><code>virt-p2v</code>需要SSH的反向端口转发功能<code>ssh -R</code>，必须在转换服务器开启此功能。</p>
<p>SSH的scp功能也必须开启。</p>
<p>转换的速度很大程度上取决于两者的网络情况。</p>
<h1 id="2gui">2.GUI交互式配置</h1>
<p>启动映像时，会有一些配置。</p>
<h2 id="21-ssh">2.1 SSH配置</h2>
<h2 id="22">2.2 磁盘和网络配置</h2>
<p>配置虚拟机的参数，virt-v2v的选项，要转换的硬盘，可移动媒体（CD...），要在虚拟机上创建的网络接口</p>
<h2 id="23">2.3 转换运行界面</h2>
<p>转换完成之后，关闭物理机，不要重启。</p>
<h1 id="3">3. 内核命令行配置</h1>
<p>如果你不想通过图形界面配置，可使用此方法。</p>
<p>在哪里设置命令行参数取决于PXE实现，但是对于pxelinux可以在<code>pxelinux.cfg</code>文件中扩展<code>APPEND</code>字段。比如：</p>
<pre><code class="shell"> DEFAULT p2v
 TIMEOUT 20
 PROMPT 0
 LABEL p2v
   KERNEL vmlinuz0
   APPEND initrd=initrd0.img [....] p2v.server=conv.example.com p2v.password=secret p2v.o=libvirt
</code></pre>

<p>下面是所有的命令行参数：</p>
<p><a href="http://libguestfs.org/virt-p2v.1.html#kernel-command-line-configuration">KERNEL COMMAND LINE CONFIGURATION</a></p>
<h1 id="4ssh">4.SSH认证</h1>
<p>比密码方式更安全的是SSH认证。</p>
<p>创建无密码的ssh密钥对，将公钥放在转换服务器的<code>authorized_keys</code>中。</p>
<p><img alt="" src="../img/virt-p2v的ssh配置.png" /></p>
<h1 id="5">5.工作方式</h1>
<p>首先建立一个或多个SSH连接来查询远程<code>virt-v2v</code>的版本及其功能。测试连接在转换开始前会被关闭。</p>
<p><code>virt-p2v</code>准备好转换时，会打开一个SSH控制连接，首先发送一个创建文件夹的命令在转换服务器上创建临时文件夹。格式：<code>/tmp/virt-p2v-YYYYMMDD-XXXXXXXX</code>。</p>
<p>其下有如下内容：</p>
<p><strong><em>dmesg</em></strong></p>
<p><strong><em>lscpu</em></strong></p>
<p><strong><em>lspci</em></strong></p>
<p><strong><em>lsscsi</em></strong></p>
<p><strong><em>lsusb</em></strong></p>
<blockquote>
<p>​ <em>(before conversion)</em></p>
<p>​ 物理机上的对应指令输出（即<a href="https://www.mankier.com/1/dmesg">dmesg(1)</a>，<a href="https://www.mankier.com/1/lscpu">lscpu(1)</a>）。</p>
<p>​ <em>dmesg</em>输出用于检查错误。其它的输出用于调试新硬件配置。</p>
</blockquote>
<p><strong><em>environment</em></strong></p>
<blockquote>
<p>​ <em>(before conversion)</em></p>
<p>​ <code>virt-v2v</code>的运行环境</p>
</blockquote>
<p><strong><em>name</em></strong></p>
<blockquote>
<p>​ <em>(before conversion)</em></p>
<p>​ 物理机的主机名</p>
</blockquote>
<p><strong><em>physical.xml</em></strong></p>
<blockquote>
<p>​ <em>(before conversion)</em></p>
<p>​ 描述物理机的libvirt XML。通过<em>-i libvirtxml</em>选项传递物理机数据给<code>virt-v2v</code>。</p>
<p>​ <strong>注意</strong>：这不是真正的libvirt XML。</p>
</blockquote>
<p><strong><em>p2v-version</em></strong></p>
<p><strong><em>v2v-version</em></strong></p>
<blockquote>
<p>​ <em>(before conversion)</em></p>
<p>​ <code>virt-v2v</code>和<code>virt-p2v</code>的版本</p>
</blockquote>
<p><strong><em>status</em></strong></p>
<blockquote>
<p>​ <em>(after conversion)</em></p>
<p>​ 最终的转换后的状态。0代表成功</p>
</blockquote>
<p><strong><em>time</em></strong></p>
<blockquote>
<p>​ <em>(before conversion)</em></p>
<p>​ 转换的开始时间</p>
</blockquote>
<p><strong><em>virt-v2v-conversion-log.txt</em></strong></p>
<blockquote>
<p>​ <em>(during/after conversion)</em></p>
<p>​ 转换日志。只有<code>virt-v2v</code>命令的输出。</p>
</blockquote>
<p><strong><em>virt-v2v-wrapper.sh</em></strong></p>
<blockquote>
<p>​ <em>(before conversion)</em></p>
<p>​ 运行<code>virt-v2v</code>时执行的封装脚本。</p>
</blockquote>
<p>在真正的转换开始之前，<code>virt-p2v</code>建立一个或多个连接用于数据传输。</p>
<p>当前的传输协议是ssh代理的<code>NBD</code>（Network Block Device）。默认是<code>qemu-nbd</code>（QEMU Disk Network Block Device Server）。</p>
<p>普通情况下每个物理硬盘都有一个ssh连接：</p>
<pre><code class="shell"> ┌──────────────┐                      ┌─────────────────┐
 │ virt-p2v     │                      │ virt-v2v        │
 │ (physical    │  control connection  │ (conversion     │
 │  server)   ╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍▶ server)       │
 │              │                      │                 │
 │              │  data connection     │                 │
 │            ╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍╍▶               │
 │qemu-nbd ← ─┘ │                      │└─ ← NBD         │
 │/dev/sda      │                      │     requests    │
 ∼              ∼                      ∼                 ∼
 └──────────────┘                      └─────────────────┘
</code></pre>

<p>因为使用了ssh的反向端口转发功能，所以实际上NBD请求可以从转换服务器发送到物理机。这样<code>virt-2v</code>可以通过libguestfs可以打开直接读取物理硬盘的nbd连接。</p>
<p>长长的virt-v2v命令被包装在脚本中然后上传到转换服务器。最后一步就是运行这个脚本，然后运行<code>virt-v2v</code>命令。virt-v2v命令引用<em>physical.xml</em>文件，该文件又引用<code>data connection</code>的NBD监听端口。</p>
<pre><code class="shell">virt-v2v -v -x --colours -i libvirtxml -o &quot;libvirt&quot; -oa sparse -os &quot;/var/tmp&quot; --root first physical.xml &lt;/dev/null
</code></pre>

<h1 id="6">6.使用</h1>
<p>先利用<code>virt-p2v-make-disk</code>制作一个运行<code>virt-p2v</code>的启动盘：</p>
<pre><code class="shell">virt-p2v-make-disk -v -o /var/tmp/p2v.img centos-7.5 2&gt;&amp;1 | tee virt-p2v.log
</code></pre>

<p>因为使用VMware虚拟机模拟物理机，所以需要再将其转换为<code>vmdk</code>格式：</p>
<pre><code class="shell">qemu-img convert -f raw p2v.img -O vmdk p2v.vmdk
</code></pre>

<p>然后将这个磁盘添加到虚拟机上面，设置开机启动进入固件，调整硬盘的启动顺序，开机时选择第一个linux内核，此时即进入了<code>virt-p2v</code>的启动盘。然后按照提示进行配置即可开始转换。</p>
<p><strong>注意</strong>：选择libvirt作为输出格式的时候，<code>os</code>选项填写<code>pool</code>的名字，可通过<code>virsh pool-list</code>查看有哪些pool。</p>
<p><img alt="" src="../img/virt-p2v迁移过程.png" /></p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../virt-p2v磁盘转换流程/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../virt-p2v磁盘转换流程/" class="btn btn-xs btn-link">
        virt-p2v磁盘转换流程
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../virt-p2v-make-disk脚本分析/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../virt-p2v-make-disk脚本分析/" class="btn btn-xs btn-link">
        virt-p2v-make-disk脚本分析
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content">
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>