<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="shihr">
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>virt-p2v介绍 - Sink</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "virt-p2v\u4ecb\u7ecd";
    var mkdocs_page_input_path = "\u865a\u62df\u673a\u8fc1\u79fb\\virt-p2v\u4ecb\u7ecd.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Sink</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">System</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../system/epel源/">epel源</a>
                </li>
                <li class="">
                    
    <a class="" href="../../system/rpms产出/">rpms产出</a>
                </li>
                <li class="">
                    
    <a class="" href="../../system/rsync配置/">rsync配置</a>
                </li>
                <li class="">
                    
    <a class="" href="../../system/主机不能连接mariadb/">主机不能连接mariadb</a>
                </li>
                <li class="">
                    
    <a class="" href="../../system/修改centos7语言/">修改centos7语言</a>
                </li>
                <li class="">
                    
    <a class="" href="../../system/修改mariadb编码类型/">修改mariadb编码类型</a>
                </li>
                <li class="">
                    
    <a class="" href="../../system/关闭selinux/">关闭selinux</a>
                </li>
                <li class="">
                    
    <a class="" href="../../system/开启图形界面/">开启图形界面</a>
                </li>
                <li class="">
                    
    <a class="" href="../../system/改变系统时区/">改变系统时区</a>
                </li>
                <li class="">
                    
    <a class="" href="../../system/磁盘容量扩充/">磁盘容量扩充</a>
                </li>
                <li class="">
                    
    <a class="" href="../../system/网卡不存在/">网卡不存在</a>
                </li>
                <li class="">
                    
    <a class="" href="../../system/通过shell命令写文件/">通过shell命令写文件</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">虚拟机迁移</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../libguestfs架构/">libguestfs架构</a>
                </li>
                <li class="">
                    
    <a class="" href="../以ova为例virt-v2v磁盘转换流程/">以ova为例virt-v2v磁盘转换流程</a>
                </li>
                <li class="">
                    
    <a class="" href="../virt-p2v-make-disk脚本分析/">virt-p2v-make-disk脚本分析</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">virt-p2v介绍</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#1">1.网络设置</a></li>
    

    <li class="toctree-l3"><a href="#2gui">2.GUI交互式配置</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#21-ssh">2.1 SSH配置</a></li>
        
            <li><a class="toctree-l4" href="#22">2.2 磁盘和网络配置</a></li>
        
            <li><a class="toctree-l4" href="#23">2.3 转换运行界面</a></li>
        
        </ul>
    

    <li class="toctree-l3"><a href="#3">3. 内核命令行配置</a></li>
    

    <li class="toctree-l3"><a href="#4ssh">4.SSH认证</a></li>
    

    <li class="toctree-l3"><a href="#5">5.工作方式</a></li>
    

    <li class="toctree-l3"><a href="#6">6.使用</a></li>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../virt-p2v磁盘转换流程/">virt-p2v磁盘转换流程</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Spice</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../spice/简介/">简介</a>
                </li>
                <li class="">
                    
    <a class="" href="../../spice/使用范例/">使用范例</a>
                </li>
                <li class="">
                    
    <a class="" href="../../spice/函数所在文件/">函数所在文件</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Python</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../python/event线程/">event线程</a>
                </li>
                <li class="">
                    
    <a class="" href="../../python/json格式处理/">json格式处理</a>
                </li>
                <li class="">
                    
    <a class="" href="../../python/执行shell命令/">执行shell命令</a>
                </li>
                <li class="">
                    
    <a class="" href="../../python/超时装饰器/">超时装饰器</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Other</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../other/CSDN语法/">CSDN语法</a>
                </li>
                <li class="">
                    
    <a class="" href="../../other/h5ai美化目录/">h5ai美化目录</a>
                </li>
                <li class="">
                    
    <a class="" href="../../other/vdsm启动失败/">vdsm启动失败</a>
                </li>
                <li class="">
                    
    <a class="" href="../../other/制作iso镜像/">制作iso镜像</a>
                </li>
                <li class="">
                    
    <a class="" href="../../other/没有打印日志/">没有打印日志</a>
                </li>
                <li class="">
                    
    <a class="" href="../../other/编译安装vdsm之后主机安装失败/">编译安装vdsm之后主机安装失败</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Make</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../make/10.使用隐含规则/">10.使用隐含规则</a>
                </li>
                <li class="">
                    
    <a class="" href="../../make/11.使用make更新归档文件/">11.使用make更新归档文件</a>
                </li>
                <li class="">
                    
    <a class="" href="../../make/16.Makefile约定/">16.Makefile约定</a>
                </li>
                <li class="">
                    
    <a class="" href="../../make/4.编写规则/">4.编写规则</a>
                </li>
                <li class="">
                    
    <a class="" href="../../make/5.编写recipes/">5.编写recipes</a>
                </li>
                <li class="">
                    
    <a class="" href="../../make/6.变量/">6.变量</a>
                </li>
                <li class="">
                    
    <a class="" href="../../make/7.Makefile中的条件语句/">7.Makefile中的条件语句</a>
                </li>
                <li class="">
                    
    <a class="" href="../../make/8.转换文本函数/">8.转换文本函数</a>
                </li>
                <li class="">
                    
    <a class="" href="../../make/简介/">简介</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">M4</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../m4/11.文本处理的宏/">11.文本处理的宏</a>
                </li>
                <li class="">
                    
    <a class="" href="../../m4/6.条件、循环、递归/">6.条件、循环、递归</a>
                </li>
                <li class="">
                    
    <a class="" href="../../m4/简介/">简介</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Java</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../java/IO/">IO</a>
                </li>
                <li class="">
                    
    <a class="" href="../../java/作用范围级别/">作用范围级别</a>
                </li>
                <li class="">
                    
    <a class="" href="../../java/synchronized关键字/">synchronized关键字</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">设计模式</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../设计模式/设计原则/">设计原则</a>
                </li>
                <li class="">
                    
    <a class="" href="../../设计模式/模式/">模式</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Linux网络编程</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../linux网络编程/函数/">函数</a>
                </li>
                <li class="">
                    
    <a class="" href="../../linux网络编程/socket通信流程/">socket通信流程</a>
                </li>
                <li class="">
                    
    <a class="" href="../../linux网络编程/简单tcp通信实现/">简单tcp通信实现</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Gluster</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../gluster/gluster安装/">gluster安装</a>
                </li>
                <li class="">
                    
    <a class="" href="../../gluster/ovirt的gluster数据恢复bug/">ovirt的gluster数据恢复bug</a>
                </li>
                <li class="">
                    
    <a class="" href="../../gluster/清理不可用的brick/">清理不可用的brick</a>
                </li>
                <li class="">
                    
    <a class="" href="../../gluster/结点故障/">结点故障</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Git</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../git/git rebase(修改历史提交)/">git rebase(修改历史提交)</a>
                </li>
                <li class="">
                    
    <a class="" href="../../git/windows无法使用git克隆/">windows无法使用git克隆</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Gerrit</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../gerrit/Apache代理添加新用户/">Apache代理添加新用户</a>
                </li>
                <li class="">
                    
    <a class="" href="../../gerrit/Gerrit submit change after abandoning its parent/">Gerrit submit change after abandoning its parent</a>
                </li>
                <li class="">
                    
    <a class="" href="../../gerrit/使用Apache代理路径错误/">使用Apache代理路径错误</a>
                </li>
                <li class="">
                    
    <a class="" href="../../gerrit/刷新gerrit项目列表/">刷新gerrit项目列表</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Datastruct</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../datastruct/二叉树/">二叉树</a>
                </li>
                <li class="">
                    
    <a class="" href="../../datastruct/散列表/">散列表</a>
                </li>
                <li class="">
                    
    <a class="" href="../../datastruct/红黑树/">红黑树</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Command</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../command/linux挂载windows共享文件夹/">linux挂载windows共享文件夹</a>
                </li>
                <li class="">
                    
    <a class="" href="../../command/sed/">sed</a>
                </li>
                <li class="">
                    
    <a class="" href="../../command/ssh免密登录/">ssh免密登录</a>
                </li>
                <li class="">
                    
    <a class="" href="../../command/tar命令打包去掉路径前缀/">tar命令打包去掉路径前缀</a>
                </li>
                <li class="">
                    
    <a class="" href="../../command/wget用法/">wget用法</a>
                </li>
                <li class="">
                    
    <a class="" href="../../command/显示文件夹大小/">显示文件夹大小</a>
                </li>
                <li class="">
                    
    <a class="" href="../../command/更新、禁用yum仓库、只下载rpm/">更新、禁用yum仓库、只下载rpm</a>
                </li>
                <li class="">
                    
    <a class="" href="../../command/添加公钥/">添加公钥</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">C and c++</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../c and c++/动态编译/">动态编译</a>
                </li>
                <li class="">
                    
    <a class="" href="../../c and c++/程序运行时间/">程序运行时间</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Bash</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../bash/3.基本shell功能/">3.基本shell功能</a>
                </li>
                <li class="">
                    
    <a class="" href="../../bash/4.shell内置命令/">4.shell内置命令</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Automake</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../automake/10.其它GNU工具/">10.其它GNU工具</a>
                </li>
                <li class="">
                    
    <a class="" href="../../automake/12.安装/">12.安装</a>
                </li>
                <li class="">
                    
    <a class="" href="../../automake/13.清理/">13.清理</a>
                </li>
                <li class="">
                    
    <a class="" href="../../automake/14.发布/">14.发布</a>
                </li>
                <li class="">
                    
    <a class="" href="../../automake/15.测试套件的支持/">15.测试套件的支持</a>
                </li>
                <li class="">
                    
    <a class="" href="../../automake/18.规则杂项/">18.规则杂项</a>
                </li>
                <li class="">
                    
    <a class="" href="../../automake/19.Include/">19.Include</a>
                </li>
                <li class="">
                    
    <a class="" href="../../automake/20.条件语句/">20.条件语句</a>
                </li>
                <li class="">
                    
    <a class="" href="../../automake/23.Automake不能满足使用时/">23.Automake不能满足使用时</a>
                </li>
                <li class="">
                    
    <a class="" href="../../automake/5.创建Makefile.in/">5.创建Makefile.in</a>
                </li>
                <li class="">
                    
    <a class="" href="../../automake/6.扫描configure.ac，使用aclocal/">6.扫描configure.ac，使用aclocal</a>
                </li>
                <li class="">
                    
    <a class="" href="../../automake/7.文件夹/">7.文件夹</a>
                </li>
                <li class="">
                    
    <a class="" href="../../automake/8.构建程序和库/">8.构建程序和库</a>
                </li>
                <li class="">
                    
    <a class="" href="../../automake/9.其它派生对象/">9.其它派生对象</a>
                </li>
                <li class="">
                    
    <a class="" href="../../automake/简介/">简介</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Autogen</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../autogen/简介/">简介</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Autoconf</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../autoconf/10.编写Autoconf宏/">10.编写Autoconf宏</a>
                </li>
                <li class="">
                    
    <a class="" href="../../autoconf/11.便携式shell编程/">11.便携式shell编程</a>
                </li>
                <li class="">
                    
    <a class="" href="../../autoconf/14.手动配置/">14.手动配置</a>
                </li>
                <li class="">
                    
    <a class="" href="../../autoconf/15.Site配置/">15.Site配置</a>
                </li>
                <li class="">
                    
    <a class="" href="../../autoconf/4.初始化和输出文件/">4.初始化和输出文件</a>
                </li>
                <li class="">
                    
    <a class="" href="../../autoconf/5.现有测试/">5.现有测试</a>
                </li>
                <li class="">
                    
    <a class="" href="../../autoconf/6.编写测试/">6.编写测试</a>
                </li>
                <li class="">
                    
    <a class="" href="../../autoconf/7.测试结果/">7.测试结果</a>
                </li>
                <li class="">
                    
    <a class="" href="../../autoconf/8.使用M4编程/">8.使用M4编程</a>
                </li>
                <li class="">
                    
    <a class="" href="../../autoconf/9.使用M4sh编程/">9.使用M4sh编程</a>
                </li>
                <li class="">
                    
    <a class="" href="../../autoconf/简介/">简介</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Algorithm</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../algorithm/复杂度分析/">复杂度分析</a>
                </li>
                <li class="">
                    
    <a class="" href="../../algorithm/选择排序/">选择排序</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Sink</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>虚拟机迁移 &raquo;</li>
        
      
    
    <li>virt-p2v介绍</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <p>原文地址：<a href="http://libguestfs.org/virt-p2v.1.html">virt-p2v</a></p>
<p>不要直接运行<code>virt-p2v</code>。你应该使用可启动<code>CDROM,ISO,PXE image</code>来启动物理机。这个映像包括virt-p2v二进制文件，并会自动地运行它。这么做的原因是被磁盘必须是非活动状态，因为其他程序会修改活动磁盘的内容。这个启动映像由<code>virt-p2v-make-disk</code>制作。</p>
<h1 id="1">1.网络设置</h1>
<p><code>virt-p2v</code>在物理机上面运行。它通过<strong>SSH</strong>与转换服务器（安装了<code>virt-v2v</code>）通信。</p>
<p><img alt="" src="../img/virt-p2v通信示意图.png" /></p>
<p><code>virt-v2v</code>执行真正的转换。</p>
<p>SSH连接总是从物理机发起。设置免密登录。</p>
<p><code>virt-p2v</code>需要SSH的反向端口转发功能<code>ssh -R</code>，必须在转换服务器开启此功能。</p>
<p>SSH的scp功能也必须开启。</p>
<p>转换的速度很大程度上取决于两者的网络情况。</p>
<h1 id="2gui">2.GUI交互式配置</h1>
<p>启动映像时，会有一些配置。</p>
<h2 id="21-ssh">2.1 SSH配置</h2>
<h2 id="22">2.2 磁盘和网络配置</h2>
<p>配置虚拟机的参数，virt-v2v的选项，要转换的硬盘，可移动媒体（CD...），要在虚拟机上创建的网络接口</p>
<h2 id="23">2.3 转换运行界面</h2>
<p>转换完成之后，关闭物理机，不要重启。</p>
<h1 id="3">3. 内核命令行配置</h1>
<p>如果你不想通过图形界面配置，可使用此方法。</p>
<p>在哪里设置命令行参数取决于PXE实现，但是对于pxelinux可以在<code>pxelinux.cfg</code>文件中扩展<code>APPEND</code>字段。比如：</p>
<pre><code class="shell"> DEFAULT p2v
 TIMEOUT 20
 PROMPT 0
 LABEL p2v
   KERNEL vmlinuz0
   APPEND initrd=initrd0.img [....] p2v.server=conv.example.com p2v.password=secret p2v.o=libvirt
</code></pre>

<p>下面是所有的命令行参数：</p>
<p><a href="http://libguestfs.org/virt-p2v.1.html#kernel-command-line-configuration">KERNEL COMMAND LINE CONFIGURATION</a></p>
<h1 id="4ssh">4.SSH认证</h1>
<p>比密码方式更安全的是SSH认证。</p>
<p>创建无密码的ssh密钥对，将公钥放在转换服务器的<code>authorized_keys</code>中。</p>
<p><img alt="" src="../img/virt-p2v的ssh配置.png" /></p>
<h1 id="5">5.工作方式</h1>
<p>首先建立一个或多个SSH连接来查询远程<code>virt-v2v</code>的版本及其功能。测试连接在转换开始前会被关闭。</p>
<p><code>virt-p2v</code>准备好转换时，会打开一个SSH控制连接，首先发送一个创建文件夹的命令在转换服务器上创建临时文件夹。格式：<code>/tmp/virt-p2v-YYYYMMDD-XXXXXXXX</code>。</p>
<p>其下有如下内容：</p>
<p><strong><em>dmesg</em></strong></p>
<p><strong><em>lscpu</em></strong></p>
<p><strong><em>lspci</em></strong></p>
<p><strong><em>lsscsi</em></strong></p>
<p><strong><em>lsusb</em></strong></p>
<blockquote>
<p>​ <em>(before conversion)</em></p>
<p>​ 物理机上的对应指令输出（即<a href="http://man.he.net/man1/dmesg">dmesg(1)</a>，<a href="http://man.he.net/man1/lscpu">lscpu(1)</a>）。</p>
<p>​ <em>dmesg</em>输出用于检查错误。其它的输出用于调试新硬件配置。</p>
</blockquote>
<p><strong><em>environment</em></strong></p>
<blockquote>
<p>​ <em>(before conversion)</em></p>
<p>​ <code>virt-v2v</code>的运行环境</p>
</blockquote>
<p><strong><em>name</em></strong></p>
<blockquote>
<p>​ <em>(before conversion)</em></p>
<p>​ 物理机的主机名</p>
</blockquote>
<p><strong><em>physical.xml</em></strong></p>
<blockquote>
<p>​ <em>(before conversion)</em></p>
<p>​ 描述物理机的libvirt XML。通过<em>-i libvirtxml</em>选项传递物理机数据给<code>virt-v2v</code>。</p>
<p>​ <strong>注意</strong>：这不是真正的libvirt XML。</p>
</blockquote>
<p><strong><em>p2v-version</em></strong></p>
<p><strong><em>v2v-version</em></strong></p>
<blockquote>
<p>​ <em>(before conversion)</em></p>
<p>​ <code>virt-v2v</code>和<code>virt-p2v</code>的版本</p>
</blockquote>
<p><strong><em>status</em></strong></p>
<blockquote>
<p>​ <em>(after conversion)</em></p>
<p>​ 最终的转换后的状态。0代表成功</p>
</blockquote>
<p><strong><em>time</em></strong></p>
<blockquote>
<p>​ <em>(before conversion)</em></p>
<p>​ 转换的开始时间</p>
</blockquote>
<p><strong><em>virt-v2v-conversion-log.txt</em></strong></p>
<blockquote>
<p>​ <em>(during/after conversion)</em></p>
<p>​ 转换日志。只有<code>virt-v2v</code>命令的输出。</p>
</blockquote>
<p><strong><em>virt-v2v-wrapper.sh</em></strong></p>
<blockquote>
<p>​ <em>(before conversion)</em></p>
<p>​ 运行<code>virt-v2v</code>时执行的封装脚本。</p>
</blockquote>
<p>在真正的转换开始之前，<code>virt-p2v</code>建立一个或多个连接用于数据传输。</p>
<p>当前的传输协议是ssh代理的<code>NBD</code>（Network Block Device）。默认是<code>qemu-nbd</code>（QEMU Disk Network Block Device Server）。</p>
<p>普通情况下每个物理硬盘都有一个ssh连接：</p>
<p><img alt="" src="../img/virt-p2v的ssh连接情况.png" /></p>
<p>因为使用了ssh的反向端口转发功能，所以实际上NBD请求可以从转换服务器发送到物理机。这样<code>virt-2v</code>可以通过libguestfs可以打开直接读取物理硬盘的nbd连接。</p>
<p>长长的virt-v2v命令被包装在脚本中然后上传到转换服务器。最后一步就是运行这个脚本，然后运行<code>virt-v2v</code>命令。virt-v2v命令引用<em>physical.xml</em>文件，该文件又引用<code>data connection</code>的NBD监听端口。</p>
<pre><code class="shell">virt-v2v -v -x --colours -i libvirtxml -o &quot;libvirt&quot; -oa sparse -os &quot;/var/tmp&quot; --root first physical.xml &lt;/dev/null
</code></pre>

<h1 id="6">6.使用</h1>
<p>先利用<code>virt-p2v-make-disk</code>制作一个运行<code>virt-p2v</code>的启动盘：</p>
<pre><code>virt-p2v-make-disk -v -o /var/tmp/p2v.img centos-7.5 2&gt;&amp;1 | tee virt-p2v.log
</code></pre>

<p>因为使用VMware虚拟机模拟物理机，所以需要再将其转换为<code>vmdk</code>格式：</p>
<pre><code>qemu-img convert -f raw p2v.img -O vmdk p2v.vmdk
</code></pre>

<p>然后将这个磁盘添加到虚拟机上面，设置开机启动进入固件，调整硬盘的启动顺序，开机时选择第一个linux内核，此时即进入了<code>virt-p2v</code>的启动盘。然后按照提示进行配置即可开始转换。</p>
<p><strong>注意</strong>：选择libvirt作为输出格式的时候，<code>os</code>选项填写<code>pool</code>的名字，可通过<code>virsh pool-list</code>查看有哪些pool。</p>
<p><img alt="" src="../img/virt-p2v迁移过程.png" /></p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../virt-p2v磁盘转换流程/" class="btn btn-neutral float-right" title="virt-p2v磁盘转换流程">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../virt-p2v-make-disk脚本分析/" class="btn btn-neutral" title="virt-p2v-make-disk脚本分析"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../virt-p2v-make-disk脚本分析/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../virt-p2v磁盘转换流程/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>

</body>
</html>
