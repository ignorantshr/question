<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="shihr">
    
    <link rel="shortcut icon" href="../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>4.vCenter转换模式 - Work Sink</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "1. \u6784\u9020URI", url: "#_top", children: [
          ]},
          {title: "2. \u6d4b\u8bd5libvirt\u5230vCenter\u7684\u8fde\u63a5", url: "#2-libvirtvcenter", children: [
          ]},
          {title: "3. \u6784\u9020\u8f93\u5165\u9009\u9879", url: "#3", children: [
              {title: "\u4e3e\u4f8b\u8bf4\u660e\uff1a", url: "#_1" },
          ]},
          {title: "4. \u8f6c\u6362\u5230ovirt\u5e73\u53f0", url: "#4-ovirt", children: [
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    <p><strong>目录</strong></p>
<div class="toc">
<ul>
<li><a href="#1-uri">1. 构造URI</a></li>
<li><a href="#2-libvirtvcenter">2. 测试libvirt到vCenter的连接</a></li>
<li><a href="#3">3. 构造输入选项</a><ul>
<li><a href="#_1">举例说明：</a></li>
</ul>
</li>
<li><a href="#4-ovirt">4. 转换到ovirt平台</a></li>
</ul>
</div>
<p>通过访问VMware vCenter服务器进行虚拟机转换。</p>
<p>要求vCenter版本&gt;=5.0。</p>
<p><strong>如果vCenter配置了防火墙，那么你需要打开防火墙端口 443(https) 和 5480。</strong></p>
<h1 id="1-uri">1. 构造URI</h1>
<p>在转换时需要一个URI链接来访问vCenter服务器。</p>
<p>一般的URI格式如下：</p>
<pre><code class="shell">vpx://user@vcenter.example.com/Datacenter/esxi?no_verify=1
</code></pre>

<ul>
<li>
<p><code>vpx</code>：固定参数，表示这是一个vCenter类型的链接</p>
</li>
<li>
<p><code>user</code>：从到vCenter服务器客户端登陆的用户名</p>
<p><img alt="" src="../img/vCenter登陆界面.png" /></p>
</li>
<li>
<p><code>vcenter.example.com</code>：ESXi服务器的IP地址或域名</p>
</li>
<li>
<p><code>Datacenter</code>：vCenter服务器上面的数据中心</p>
</li>
<li>
<p><code>esxi</code>：vCenter上的ESXi服务器路径</p>
</li>
<li>
<p><code>?no_verify=1</code>：用于取消TLS证书检查。</p>
</li>
</ul>
<p>下文中有举例构造URI的说明。</p>
<p>如果使用文件夹部署VMware，可能需要将其添加到URI，例如：</p>
<pre><code class="shell"> vpx://user@server/Folder/Datacenter/esxi?no_verify=1
</code></pre>

<p><strong>注意</strong>：如果URI链接中存在特殊符号则需要替换为ASCII 十六进制码。比如<code>vpx://administrator@vsphere.local@vcenter.example.com/Datacenter/esxi</code>应写为<code>vpx://administrator%40vsphere.local@vcenter.example.com/Datacenter/esxi</code>（@的ASCII 十六进制码是40）。</p>
<h1 id="2-libvirtvcenter">2. 测试libvirt到vCenter的连接</h1>
<p>在转换之前，首先确保该URI是有效的，使用<code>virsh</code>命令测试：</p>
<pre><code class="shell">$ virsh -c 'vpx://user@vcenter.example.com/Datacenter/esxi?no_verify=1' list --all
 Enter root's password for vcenter.example.com: ***

  Id    Name                           State
 ----------------------------------------------------
  -     Fedora 20                      shut off
  -     Windows 2003                   shut off
</code></pre>

<p>如果能看到虚拟机列表，则进一步测试：</p>
<pre><code class="shell"> $ virsh -c 'vpx://user@vcenter.example.com/Datacenter/esxi?no_verify=1' dumpxml &quot;Windows 2003&quot;
 &lt;domain type='vmware'&gt;
   &lt;name&gt;Windows 2003&lt;/name&gt;
   [...]
 &lt;/domain&gt;
</code></pre>

<p>如果成功输出配置文件信息，那么表示该URI可用。</p>
<p><strong><code>警告</code></strong>：如果测试失败，那么虚拟机转换不会成功！</p>
<h1 id="3">3. 构造输入选项</h1>
<p>在vCenter模式的转换方式下，转换脚本的输入选项有以下几个：</p>
<ul>
<li><code>--mode</code>：转换模式。此处为vCenter。</li>
<li><code>--uri</code>：连接到vCenter服务器的远程链接。</li>
<li><code>--vm-name</code>：要转换的虚拟机名字。此虚拟机必须在测试URI连接结果的虚拟机列表中。</li>
<li><code>--password-file</code>：存放登录到vCenter服务器密码的文件。该文件存放在转换服务器上面，文件中的密码必须是完整的密码且不能跟随任何换行符。可选选项，如果不指定在转换时需要手动输入密码。</li>
</ul>
<h4 id="_1">举例说明：</h4>
<p>现在有一台vCenter服务器，IP地址为<code>172.16.2.178</code>，vCenter客户端的登录用户名及域为<code>administrator@vsphere.local</code>，密码存放在转换服务器的<code>vcenter.pass</code>文件中；一台ESXi服务器，其IP地址为<code>172.16.2.179</code>，上面有一台虚拟机<code>centos-esxi-1</code>；vCenter上的ESXi服务器所在路径如下图所示：</p>
<p><img alt="" src="../img/vcenter-esxi位置.png" /></p>
<p>那么其URI：</p>
<pre><code class="shell">vpx://administrator%40vsphere.local@172.16.2.178/Datacenter-test/cluster-test/172.16.2.179?no_verify=1
</code></pre>

<p>注意：该链接中的连接用户名和域名的<code>@</code>符号被替换为ASCII 十六进制码<code>%40</code>。</p>
<p>然后在转换服务器上进行连接测试：</p>
<pre><code class="shell">$ virsh -c 'vpx://administrator%40vsphere.local@172.16.2.178/Datacenter-test/cluster-test/172.16.2.179?no_verify=1' list --all
Enter administrator@vsphere.local's password for 172.16.2.178:
 Id    Name                           State
----------------------------------------------------
 -     centos-esxi-1                  shut off
</code></pre>

<p>进一步的测试：</p>
<pre><code class="shell">$ virsh -c 'vpx://administrator%40vsphere.local@172.16.2.178/Datacenter-test/cluster-test/172.16.2.179?no_verify=1' dumpxml &quot;centos-esxi-1&quot;
Enter administrator@vsphere.local's password for 172.16.2.178:
&lt;domain type='vmware' xmlns:vmware='http://libvirt.org/schemas/domain/vmware/1.0'&gt;
  &lt;name&gt;centos-esxi-1&lt;/name&gt;
   [...]
 &lt;/domain&gt;
</code></pre>

<p>测试成功，输入选项构造如下：</p>
<pre><code class="shell">--mode vCenter --uri vpx://administrator%40vsphere.local@172.16.2.178/Datacenter-test/cluster-test/172.16.2.179?no_verify=1 --vm-name centos-esxi-1 --password-file vcenter.pass
</code></pre>

<h1 id="4-ovirt">4. 转换到ovirt平台</h1>
<p>参考：<a href="../转换到ovirt平台/">转换到ovirt平台</a></p>

  <br>
    

    <br>
</div>

<footer class="col-md-12 wm-page-content">
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>