<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="shihr">
    
    <link rel="shortcut icon" href="../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>以ova为例virt-v2v磁盘转换流程 - Work Sink</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "1.\u89e3\u6790\u547d\u4ee4\u884c\uff0c\u521d\u59cb\u5316\u8f93\u5165\u8f93\u51fa\u6a21\u5757", url: "#_top", children: [
          ]},
          {title: "2.\u83b7\u53d6\u4fe1\u606f", url: "#2", children: [
          ]},
          {title: "2.1\u5904\u7406\u8f93\u5165", url: "#21", children: [
          ]},
          {title: "3.\u521b\u5efaoverlay\u78c1\u76d8\uff08copy\u6a21\u5f0f\u72ec\u6709\uff09", url: "#3overlaycopy", children: [
          ]},
          {title: "4.\u521d\u59cb\u5316target\u7ed3\u6784\u4f53\uff08copy\u6a21\u5f0f\u72ec\u6709\uff09", url: "#4targetcopy", children: [
          ]},
          {title: "5.\u521b\u5efa\u5904\u7406\u5668", url: "#5", children: [
          ]},
          {title: "6.\u542f\u52a8appliance\u3001\u5b88\u62a4\u8fdb\u7a0bguestfsd", url: "#6applianceguestfsd", children: [
          ]},
          {title: "7.\u68c0\u6d4b\u6e90\u78c1\u76d8\uff0c\u83b7\u53d6\u4fe1\u606f", url: "#7", children: [
          ]},
          {title: "8.\u4f30\u7b97\u6bcf\u4e2a target disk \u7684\u7a7a\u95f4\u8981\u6c42", url: "#8-target-disk", children: [
          ]},
          {title: "9.\u8fdb\u884c\u78c1\u76d8\u8f6c\u6362", url: "#9", children: [
          ]},
          {title: "10.\u51cf\u5c11\u8f6c\u6362\u91cf", url: "#10", children: [
          ]},
          {title: "11.\u5173\u95ed\u5b88\u62a4\u8fdb\u7a0b", url: "#11", children: [
          ]},
          {title: "12.\u5206\u914d\u78c1\u76d8\u5230\u603b\u7ebf", url: "#12", children: [
          ]},
          {title: "13.\u521b\u5efa\u76ee\u7684\u78c1\u76d8", url: "#13", children: [
              {title: "13.1\u521b\u5efa\u76ee\u7684\u78c1\u76d8", url: "#131" },
              {title: "13.2\u8f6c\u6362\u76ee\u7684\u78c1\u76d8", url: "#132" },
          ]},
          {title: "14.\u751f\u6210 metadata \u6587\u4ef6", url: "#14-metadata", children: [
          ]},
          {title: "15.\u4e24\u79cd\u8f6c\u6362\u6a21\u5f0f", url: "#15", children: [
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    <h3 id="1">1.解析命令行，初始化输入输出模块</h3>
<pre><code class="ocaml">let cmdline, input, output = parse_cmdline () in
</code></pre>

<h3 id="2">2.获取信息</h3>
<pre><code class="ocaml">let source = open_source cmdline input in
</code></pre>

<h3 id="21">2.1处理输入</h3>
<pre><code class="ocaml">let source = input#source () in
</code></pre>

<p>日志：</p>
<pre><code class="shell">tar -xf 'centos2.ova' -C '/var/tmp/ova.x0YFry'
</code></pre>

<p>信息日志：</p>
<pre><code class="shell">source name: centos2
hypervisor type: vmware
         memory: 1073741824 (bytes)
       nr vCPUs: 1
     CPU vendor:
      CPU model:
   CPU topology:
   CPU features:
       firmware: bios
        display:
          video:
          sound:
disks:
        /var/tmp/ova.x0YFry/centos2-disk1.vmdk (vmdk) [scsi]
removable media:
        CD-ROM [ide] in slot 0
NICs:
        Bridge &quot;nat&quot; [e1000]
</code></pre>

<h3 id="3overlaycopy">3.创建overlay磁盘（copy模式独有）</h3>
<pre><code class="ocaml">let overlays = create_overlays source.s_disks in
</code></pre>

<p>日志：</p>
<pre><code class="shell">qemu-img 'create' '-q' '-f' 'qcow2' '-b' '/var/tmp/ova.x0YFry/centos2-disk1.vmdk' '-o' 'compat=1.1,backing_fmt=vmdk' '/var/tmp/v2vovl36099b.qcow2'
</code></pre>

<h3 id="4targetcopy">4.初始化target结构体（copy模式独有）</h3>
<pre><code class="ocaml">let targets = init_targets cmdline output source overlays in
</code></pre>

<h3 id="5">5.创建处理器</h3>
<pre><code class="ocaml">let g = open_guestfs ~identifier:&quot;v2v&quot; () in
</code></pre>

<h3 id="6applianceguestfsd">6.启动appliance、守护进程guestfsd</h3>
<pre><code class="ocaml">g#launch ();
</code></pre>

<ol>
<li>supermin5创建appliance，测试qemu，使用qemu-kvm开启appliance</li>
<li>supermin5载入模块；创建设备目录（/dev/**）并挂载；设置网络；分配逻辑卷组</li>
<li>libguestfs接收到GUESTFS_LAUNCH_FLAG信号，appliance启动成功</li>
</ol>
<h3 id="7">7.检测源磁盘，获取信息</h3>
<pre><code class="ocaml">let inspect = Inspect_source.inspect_source cmdline.root_choice g in
</code></pre>

<p>日志：</p>
<pre><code class="shell">i_root = /dev/cl/root
i_type = linux
i_distro = centos
i_arch = x86_64
i_major_version = 7
i_minor_version = 5
i_package_format = rpm
i_package_management = yum
i_product_name = CentOS Linux release 7.5.1804 (Core)
i_product_variant = unknown
i_firmware = BIOS
i_windows_systemroot =
i_windows_software_hive =
i_windows_system_hive =
i_windows_current_control_set =
</code></pre>

<h3 id="8-target-disk">8.估算每个 target disk 的空间要求</h3>
<pre><code class="ocaml">  let mpstats = get_mpstats g in
  check_guest_free_space mpstats;
  check_target_free_space mpstats source targets output
</code></pre>

<p>日志：</p>
<pre><code class="shell">[ 133.5] Checking for sufficient free disk space in the guest
[ 133.5] Estimating space required on target for each disk
mpstats:
mountpoint statvfs /dev/sda1 /boot (xfs):
  bsize=4096 blocks=259584 bfree=224126 bavail=224126
mountpoint statvfs /dev/cl/root / (xfs):
  bsize=4096 blocks=4452864 bfree=4185952 bavail=4185952
estimate_target_size: fs_total_size = 19302187008 [18.0G]
estimate_target_size: source_total_size = 21474836480 [20.0G]
estimate_target_size: ratio = 0.899
estimate_target_size: fs_free = 18063679488 [16.8G]
estimate_target_size: scaled_saving = 16236143164 [15.1G]
estimate_target_size: sda: 5238693316 [4.9G]
</code></pre>

<h3 id="9">9.进行磁盘转换</h3>
<pre><code class="ocaml">let guestcaps = do_convert g inspect source output rcaps in
</code></pre>

<p>结果日志：</p>
<pre><code class="shell">guestcaps:
rm_f = 0
gcaps_block_bus = virtio-blk
gcaps_net_bus = virtio-net
gcaps_video = qxl
gcaps_arch = x86_64
gcaps_acpi = true
virt-v2v: This guest has virtio drivers installed.
</code></pre>

<p>detect_kernels日志</p>
<pre><code class="shell">kernels offered by the bootloader in this guest (first in list is default):
* kernel 3.10.0-514.el7.x86_64 (x86_64)
        /boot/vmlinuz-3.10.0-514.el7.x86_64 -- kernel_info.ki_vmlinuz
        /boot/initramfs-3.10.0-514.el7.x86_64.img -- kernel_info.ki_initrd
        /boot/config-3.10.0-514.el7.x86_64 -- kernel_info.ki_config_file
        /lib/modules/3.10.0-514.el7.x86_64 -- kernel_info.ki_modpath
        2347 modules found
        virtio: blk=true net=true rng=true balloon=true -- ki.ki_supports_virtio_blk ki.ki_supports_virtio_net 
        pvpanic=true xen=false debug=false -- ki.ki_is_xen_pv_only_kernel ki.ki_is_debug
</code></pre>

<p>remap_block_devices日志</p>
<pre><code class="shell">block device map:
        sda     -&gt; vda
        xvda    -&gt; vda
...
libguestfs: trace: v2v: aug_get &quot;/files/boot/grub2/device.map/hd0&quot;
libguestfs: trace: v2v: aug_get = &quot;/dev/sda&quot;
libguestfs: trace: v2v: aug_set &quot;/files/boot/grub2/device.map/hd0&quot; &quot;/dev/vda&quot;
</code></pre>

<h3 id="10">10.减少转换量</h3>
<pre><code class="ocaml">g#umount_all ();
do_fstrim g inspect;
</code></pre>

<p>日志：</p>
<pre><code class="shell">libguestfs: trace: v2v: fstrim &quot;/&quot;
guestfsd: &lt;= fstrim (0x14e) request length 72 bytes
commandrvf: fstrim -v /sysroot/
/sysroot/: 16 GiB (17179185152 bytes) trimmed
guestfsd: =&gt; fstrim (0x14e) took 0.15 secs
libguestfs: trace: v2v: fstrim = 0
</code></pre>

<h3 id="11">11.关闭守护进程</h3>
<pre><code class="ocaml">g#umount_all ();
g#shutdown ();
g#close ();
</code></pre>

<p>日志：</p>
<pre><code class="shell">umount-all: /proc/mounts: fsname=rootfs dir=/ type=rootfs opts=rw freq=0 passno=0
umount-all: /proc/mounts: fsname=proc dir=/proc type=proc opts=rw,relatime freq=0 passno=0
umount-all: /proc/mounts: fsname=/dev/root dir=/ type=ext2 opts=rw,noatime freq=0 passno=0
umount-all: /proc/mounts: fsname=/proc dir=/proc type=proc opts=rw,relatime freq=0 passno=0
umount-all: /proc/mounts: fsname=/sys dir=/sys type=sysfs opts=rw,relatime freq=0 passno=0
...
libguestfs: sending SIGTERM to process 6353
libguestfs: qemu maxrss 604960K
libguestfs: trace: v2v: shutdown = 0
libguestfs: trace: v2v: close
libguestfs: closing guestfs handle 0x2488810 (state 0)
libguestfs: command: run: rm
libguestfs: command: run: \ -rf /tmp/libguestfsCZ1315
libguestfs: command: run: rm
libguestfs: command: run: \ -rf /tmp/libguestfs5EMQ5o
</code></pre>

<p><strong>----------------------------------以下是copy模式独有的步骤-------------------------</strong></p>
<h3 id="12">12.分配磁盘到总线</h3>
<pre><code>let target_buses =
         Target_bus_assignment.target_bus_assignment source targets guestcaps in
</code></pre>

<p>日志：</p>
<pre><code class="shell">[ 188.3] Assigning disks to buses
virtio-blk slot 0:
target_file = [file] /var/tmp/qemu-vm/centos2-sda
target_format = qcow2
target_estimated_size = 5238693316
target_overlay = /var/tmp/v2vovl36099b.qcow2
target_overlay.ov_source = /var/tmp/ova.x0YFry/centos2-disk1.vmdk
ide slot 0:
        CD-ROM [ide] in slot 0
</code></pre>

<h3 id="13">13.创建目的磁盘</h3>
<pre><code class="ocaml">let targets = 
    if not cmdline.do_copy then targets
    else copy_targets cmdline targets input output in
</code></pre>

<h4 id="131">13.1创建目的磁盘</h4>
<pre><code class="ocaml">output#disk_create
    t.target_file t.target_format t.target_overlay.ov_virtual_size
    ?preallocation ?compat;
</code></pre>

<p>日志：</p>
<pre><code class="shell">[ 188.3] Copying disk 1/1 to /var/tmp/qemu-vm/centos2-sda (qcow2)
target_file = [file] /var/tmp/qemu-vm/centos2-sda
target_format = qcow2
target_estimated_size = 5238693316
target_overlay = /var/tmp/v2vovl36099b.qcow2
target_overlay.ov_source = /var/tmp/ova.x0YFry/centos2-disk1.vmdk

disk_create &quot;/var/tmp/qemu-vm/centos2-sda&quot; &quot;qcow2&quot; 21474836480 &quot;preallocation:sparse&quot; &quot;compat:1.1&quot;
</code></pre>

<h4 id="132">13.2转换目的磁盘</h4>
<pre><code class="ocaml">let cmd = [ &quot;qemu-img&quot;; &quot;convert&quot; ] @
        (if not (quiet ()) then [ &quot;-p&quot; ] else []) @
        [ &quot;-n&quot;; &quot;-f&quot;; &quot;qcow2&quot;; &quot;-O&quot;; t.target_format ] @
        (if cmdline.compressed then [ &quot;-c&quot; ] else []) @
        [ overlay_file; t.target_file ] in

run_command cmd
</code></pre>

<p>日志：</p>
<pre><code class="shell">qemu-img 'convert' '-p' '-n' '-f' 'qcow2' '-O' 'qcow2' '/var/tmp/v2vovl36099b.qcow2' '/var/tmp/qemu-vm/centos2-sda'
</code></pre>

<h3 id="14-metadata">14.生成 metadata 文件</h3>
<pre><code class="ocaml">output#create_metadata source targets target_buses guestcaps inspect
       target_firmware;
</code></pre>

<p>日志：</p>
<pre><code class="shell">Creating output metadata
</code></pre>

<h3 id="15">15.两种转换模式</h3>
<p><strong>15.1 <code>copying</code>模式</strong>：</p>
<p>在这种模式下，磁盘的转换流程是这样的：<code>source -&gt; overlay -&gt; target</code>。</p>
<ol>
<li>获取原VM的一个或多个磁盘source描述。</li>
<li>在源磁盘的上面放可写的叠加磁盘overlay。</li>
<li>在overlay上面做转换。</li>
<li>复制overlay到目标磁盘target。</li>
</ol>
<p><strong>15.2 <code>in place</code>模式</strong>：不会在目标Hypervisor创建新的虚拟机，而是调整原VM的操作系统以在输入的Hypervisor上运行。</p>
<pre><code class="shell">virt-v2v -ic qemu:///system converted_vm --in-place
</code></pre>

<p><code>virt-v2v</code>默认使用<code>copying</code>模式，在以下场景中可能会用到<code>in place</code>模式：</p>
<p>​   一个外来VM已经被导入到基于KVM的Hypervisor上，但是仍然需要在guest上面调整使它运行在新的虚拟硬件上。</p>
<p>​   在这种情况下，假设第三方工具基于原VM配置和内容在支持的基于KVM的Hypervisor中创建了目标VM，但是需要使用更适合KVM的虚拟设备（比如virtio存储网络、网络等）。</p>
<p><strong>15.3 两种模式的区别</strong>：</p>
<table>
<thead>
<tr>
<th align="center">转换模式</th>
<th align="center">copying</th>
<th align="center">in place</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">是否在源磁盘上做修改</td>
<td align="center">否</td>
<td align="center">是</td>
</tr>
<tr>
<td align="center">是否创建overlays磁盘</td>
<td align="center">是</td>
<td align="center">否</td>
</tr>
<tr>
<td align="center">在哪个磁盘上做转换</td>
<td align="center">overlay磁盘</td>
<td align="center">源磁盘</td>
</tr>
</tbody>
</table>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../virt-p2v-make-disk脚本分析/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../virt-p2v-make-disk脚本分析/" class="btn btn-xs btn-link">
        virt-p2v-make-disk脚本分析
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../libguestfs架构/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../libguestfs架构/" class="btn btn-xs btn-link">
        libguestfs架构
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content">
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>