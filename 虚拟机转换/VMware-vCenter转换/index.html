<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="shihr">
    
    <link rel="shortcut icon" href="../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>VMware-vCenter转换 - Work Sink</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "VMware-vCenter\u865a\u62df\u673a\u8f6c\u6362", url: "#_top", children: [
              {title: "\u8f93\u5165\u6a21\u5f0f", url: "#_1" },
              {title: "1. vCenter\uff1a\u4ecewindows\u5ba2\u6237\u673a\u79fb\u9664VMware-tools", url: "#1-vcenterwindowsvmware-tools" },
              {title: "2. vCenter\uff1aURI", url: "#2-vcenteruri" },
              {title: "3. \u6d4b\u8bd5libvirt\u5230vCenter\u7684\u8fde\u63a5", url: "#3-libvirtvcenter" },
              {title: "4. vCenter\uff1a\u5bfc\u5165\u865a\u62df\u673a", url: "#4-vcenter" },
              {title: "5. vCenter\uff1aNon-Administrator \u89d2\u8272", url: "#5-vcenternon-administrator" },
              {title: "6. vCenter\uff1a\u9632\u706b\u5899\u53ca\u4ee3\u7406\u8bbe\u7f6e", url: "#6-vcenter" },
              {title: "7. vCenter\uff1aSSL/TLS \u8bc1\u4e66\u95ee\u9898", url: "#7-vcenterssltls" },
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    <h1 id="vmware-vcenter">VMware-vCenter虚拟机转换</h1>
<p>从<code>VMware vCenter</code>转换虚拟机到<code>ovirt</code>平台。</p>
<p><strong>要求</strong>：vCenter &gt;= 5.0</p>
<p>举例场景：</p>
<blockquote>
<p>有一个VMware vCenter服务器，地址是<code>vcenter.example.com</code>，一个数据中心<code>Datacenter</code>，和一个<code>ESXi hypervisor</code>叫做<code>esxi</code>。要转换的虚拟机叫<code>vmware_guest</code>。</p>
</blockquote>
<pre><code class="shell"> virt-v2v -ic vpx://vcenter.example.com/Datacenter/esxi vmware_guest \
   -o rhv-upload -oc https://ovirt-engine.example.com/ovirt-engine/api \
   -os ovirt-data -op /tmp/ovirt-admin-password -of raw \
   -oo rhv-cafile=/tmp/ca.pem -oo rhv-direct \
   --bridge ovirtmgmt
</code></pre>

<p>输出到ovirt参考：<a href="../VMware-ova转换/">VMware-ova转换</a></p>
<h2 id="_1">输入模式</h2>
<p>默认使用libvirt从vCenter获取信息，所以使用该模式时默认添加<code>-i libvirt</code>选项。</p>
<h2 id="1-vcenterwindowsvmware-tools">1. vCenter：从windows客户机移除<code>VMware-tools</code></h2>
<p>对于windows客户机，在转换之前需要将<code>VMware-tools</code>移除。否则在转换完成之后每次启动客户机的时候都会抱怨，并且该工具不能卸载。</p>
<h2 id="2-vcenteruri">2. vCenter：URI</h2>
<p>libvirt <code>URI</code>格式：</p>
<pre><code class="shell">vpx://user@server/Datacenter/esxi
</code></pre>

<ul>
<li>
<p>user@</p>
<blockquote>
<p>可选。如果包含<code>\</code>（eg. <code>DOMAIN\USER</code>），使用<code>%5c</code>（十六进制ASCII码）代替（eg. <code>DOMAIN%5cUSER</code>）。其它标点符号可能也需要如此。@是<code>%40</code>，<code>.</code>不需要转换，<a href="https://www.mokuge.com/tool/asciito16/">可在此查询</a>。这个地方一定要加上域名，例：<code>vpx://administrator%40vsphere.local@172.16.2.178/Datacenter/cluster/172.16.2.162?no_verify=1</code></p>
</blockquote>
</li>
<li>
<p>server</p>
<blockquote>
<p>服务器域名</p>
</blockquote>
</li>
<li>
<p>Datacenter</p>
<blockquote>
<p>数据中心的名字。空格使用<code>%20</code>代替。</p>
</blockquote>
</li>
<li>
<p>esxi</p>
<blockquote>
<p>运行虚拟机的ESXi hypervisor的名字</p>
</blockquote>
</li>
</ul>
<p>如果使用文件夹部署VMware，可能需要将其添加到URI，eg：</p>
<pre><code class="shell"> vpx://user@server/Folder/Datacenter/esxi
</code></pre>

<p><a href="http://libvirt.org/drvesx.html">详细的libvirt URIs</a></p>
<h2 id="3-libvirtvcenter">3. 测试libvirt到vCenter的连接</h2>
<p>使用<code>virsh</code>列出虚拟机：</p>
<pre><code class="shell"> $ virsh -c 'vpx://root@vcenter.example.com/Datacenter/esxi' list --all
 Enter root's password for vcenter.example.com: ***

  Id    Name                           State
 ----------------------------------------------------
  -     Fedora 20                      shut off
  -     Windows 2003                   shut off
</code></pre>

<p>如果出现了证书相关的问题，可以导入vCenter主机的证书，或者跳过证书验证：</p>
<pre><code class="shell">$ virsh -c 'vpx://root@vcenter.example.com/Datacenter/esxi?no_verify=1' list --all
</code></pre>

<p>你也应该尝试从任意虚拟机复制元数据：</p>
<pre><code class="shell">$ virsh -c 'vpx://root@vcenter.example.com/Datacenter/esxi' dumpxml &quot;Windows 2003&quot;
 &lt;domain type='vmware'&gt;
   &lt;name&gt;Windows 2003&lt;/name&gt;
   [...]
 &lt;/domain&gt;
</code></pre>

<p><strong>如果上述步骤失败了，那么就不能进行转换！</strong></p>
<h2 id="4-vcenter">4. vCenter：导入虚拟机</h2>
<pre><code class="shell"> $ virt-v2v -ic 'vpx://root@vcenter.example.com/Datacenter/esxi?no_verify=1' \
   &quot;Windows 2003&quot; \
   -o local -os /var/tmp
</code></pre>

<p><strong>虚拟机必须关机</strong>。</p>
<p>如果不想在转换时输入密码，使用<code>--password-file &lt;file&gt;</code>选项指定密码文件。</p>
<h2 id="5-vcenternon-administrator">5. vCenter：Non-Administrator 角色</h2>
<p>可以使用非管理员角色执行转换，但是需要为其提供最小权限：</p>
<ol>
<li>
<p>在vCenter创建角色</p>
</li>
<li>
<p>打开以下对象
<pre></p>
<p>Datastore:
   - Browse datastore
   - Low level file operations</p>
<p>Sessions:
   - Validate session</p>
<p>Virtual Machine:
    Provisioning:
      - Allow disk access
      - Allow read-only disk access
      - Guest Operating system management by VIX API
</pre></p>
</li>
</ol>
<h2 id="6-vcenter">6. vCenter：防火墙及代理设置</h2>
<h3 id="61-vcenter">6.1 vCenter：端口</h3>
<p>若是有防火墙，需要打开<code>443</code>（https）和<code>5480</code>端口。前者用于复制磁盘，后者用于查询虚拟机元数据。</p>
<p>如果使用了非默认端口，需要在URI中指定。这些端口只用于virt-v2v转换，如果想要使用其他功能需要打开其他端口。</p>
<pre><code class="shell"> ┌────────────┐   port 443 ┌────────────┐        ┌────────────┐
 │ virt-v2v   │───────────▶ vCenter    │────────▶ ESXi       │
 │ conversion │────────────▶ server     │        │ hypervisor │
 │ server     │  port 5480 │            │        │   ┌─────┐  │
 └────────────┘            └────────────┘        │   │guest│  │
                                                 └───┴─────┴──┘
</code></pre>

<p>箭头表示TCP启动方向，不是数据传输方向。</p>
<p>从图中可以看出，virt-v2v 不是直接和ESXI连接，而是vCenter连接到hypervisor，所以，如果在vCenter与hypervisor之间有防火墙的话，需要打开额外的端口。</p>
<p>在做转换时代理环境变量（<code>https_proxy</code>, <code>all_proxy</code>, <code>no_proxy</code>, <code>HTTPS_PROXY</code>, <code>ALL_PROXY</code> and <code>NO_PROXY</code>）会失效。</p>
<h2 id="7-vcenterssltls">7. vCenter：SSL/TLS 证书问题</h2>
<p>可能会看到这个错误：</p>
<pre><code class="shell">  CURL: Error opening file: SSL: no alternative certificate subject
  name matches target host name
</code></pre>

<p>（也许打开调试模式<code>virt-v2v -v -x</code>才能看到这个信息）</p>
<p>这是因为使用了IP地址访问，需要使用vCenter服务器完全合格的域名。</p>
<p>vCenter服务器不匹配的<code>FQDN</code>和IP地址（比如服务器获取了一个新的ip地址）会导致另一个证书问题。修复方法：改变DHCP服务或网络服务配置，让vCenter服务器有一个固定的IP地址；然后登录vCenter服务器的admin控制台<code>https://vcenter:5480/</code>，在<code>Admin</code>标签下，选择<code>Certificate regeneration enabled</code>，然后重启。</p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../VMware-ESXI-hypervisor转换/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../VMware-ESXI-hypervisor转换/" class="btn btn-xs btn-link">
        VMware-ESXI-hypervisor转换
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../VMware-vmx转换/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../VMware-vmx转换/" class="btn btn-xs btn-link">
        VMware-vmx转换
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content">
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>