<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="shihr">
    
    <link rel="shortcut icon" href="../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>VMware-ova转换 - Work Sink</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "VMware-ova\u865a\u62df\u673a\u8f6c\u6362", url: "#_top", children: [
              {title: "\u521b\u5efaova", url: "#ova" },
              {title: "\u6302\u8f7d\u76ee\u5f55", url: "#_1" },
              {title: "\u6267\u884c\u8f6c\u6362", url: "#_2" },
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    <h1 id="vmware-ova">VMware-ova虚拟机转换</h1>
<p>所有的VMware平台的windows虚拟机都需要先卸载<code>VMware-tools</code>。</p>
<h2 id="ova">创建ova</h2>
<p>创建ova文件有两种方式。第一种是通过界面的导出ovf，ovf形式导出为文件夹，ova形式导出为文件。第二种是使用VMware的专有工具<code>ovftool</code>：</p>
<pre><code class="shell"> ovftool --noSSLVerify \
   vi://USER:PASSWORD@esxi.example.com/VM \
   VM.ova
</code></pre>

<p>连接到vCenter：</p>
<pre><code class="shell"> ovftool  --noSSLVerify \
   vi://USER:PASSWORD@vcenter.example.com/DATACENTER-NAME/vm/VM \
   VM.ova
</code></pre>

<p>对于Active Directory-aware验证，你必须以ascii十六进制代码（\）的形式表达@字符：</p>
<pre><code class="shell"> vi://DOMAIN%5cUSER:PASSWORD@...
</code></pre>

<h2 id="_1">挂载目录</h2>
<ol>
<li>
<p>Linux安装挂载工具</p>
<pre><code>yum install cifs-utils
</code></pre>
</li>
<li>
<p>挂载windows目录</p>
<pre><code>mount.cifs [//172.16.2.27/ova](notion://172.16.2.27/ova) /tmp/ova_tmp -o user=phy,pass=KVM.123456
</code></pre>
<p>挂载失败使用加上参数：</p>
<pre><code>mount.cifs //172.16.2.27/ova ova_tmp/ -o user=phy,pass=KVM.123456,sec=ntlm
</code></pre>
</li>
</ol>
<h2 id="_2">执行转换</h2>
<ol>
<li>
<p>输出到ovirt的选项</p>
<pre><code>virt-v2v -i ova guest.ova \
   -o rhv-upload -oc https://ovirt-engine.example.com/ovirt-engine/api \
   -os ovirt-data -op /tmp/ovirt-admin-password -of raw \
   -oo rhv-cafile=/tmp/ca.pem -oo rhv-direct \
   --bridge ovirtmgmt
</code></pre>
<p>通过REST API直接上传客户机到oVirt或RHV，要求 <strong><code>oVirt/RHV ≥ 4.2</code></strong></p>
<ol>
<li>指定<code>-o rhv-upload</code></li>
<li>
<p><code>-oc</code> https://ovirt-engine.example.com/ovirt-engine/api?username=admin@internal</p>
<p>可向URL添加用户名或端口号，如果没有指定用户名则使用<code>admin@internal</code></p>
</li>
<li>
<p><code>-of</code> raw</p>
<p>只能输出raw格式的磁盘</p>
</li>
<li>
<p><code>-op</code> password-file</p>
<p>用于连接ovirt-engine的密码文件。该文件应包含完整的密码，末尾不能有换行符，权限改为0600。</p>
</li>
<li>
<p><code>-os</code> ovirt-data</p>
<p>存储域</p>
</li>
<li>
<p><code>-oo</code> rhv-cafile=ca.pem</p>
<p>ca.pem文件（证书颁发机构），从ovirt-engine上的<code>/etc/pki/ovirt-engine/ca.pem</code>复制。</p>
</li>
<li>
<p><code>-oo</code> rhv-cluster=CLUSTERNAME</p>
<p>集群的名字。默认使用<code>Default</code></p>
</li>
<li>
<p><code>-oo</code> rhv-direct</p>
<p>表示会直接上传磁盘到ovirt-node，否则通过ovirt-engine代理上传磁盘。直接上传要求网络能访问到node。非直接上传的方式会有点慢，但是能在所有的情况下使用。</p>
</li>
<li>
<p><code>-oo</code> rhv-verifypeer</p>
<p>通过针对颁发机构检查服务器的证书来验证oVirt/RHV服务器的身份。</p>
</li>
</ol>
</li>
<li>
<p>输出到ovirt（老方法）</p>
<p>本节说明只适用于<code>-o rhv</code>输出模式。</p>
<p>如果你使用RHV-M用户界面的virt-v2v，那么在后台使用<code>-o vdsm</code>输出模式由vdsm管理导入。</p>
<p>你必须指定<code>-o rhv</code>和<code>-os</code>选项指明RHV-M的导出域。也可以指定NFS服务器和挂载点，例如<em>-os rhv-storage:/rhv/export</em>，或者先挂载然后指定挂载点，例如<em>-os /tmp/mnt</em>。<strong>不要指向数据域</strong>。</p>
<p>不支持<code>-oo</code>、<code>-op</code>选项，不需要<code>-oc</code>选项。</p>
</li>
<li>
<p>实际操作</p>
</li>
</ol>
<p><strong>准备环境</strong></p>
<pre><code class="shell">#安装pip
wget https://bootstrap.pypa.io/get-pip.py
python get-pip.py
#安装ovirtsdk4模块
yum install gcc libxml2-devel python-devel
pip install ovirt-engine-sdk-python==4.2.5
</code></pre>

<p><strong>进行转换</strong></p>
<pre><code class="shell">virt-v2v -v -x -i ova ova_190319140049/centos2.ova -o rhv -os 172.16.2.124:/home/exports -of raw/qcow2 -bridge ovirtmgmt 2&gt;&amp;1 | tee virt-v2v-ovirt.log
</code></pre>

<p><strong>问题</strong></p>
<p>由于ova不包含网卡的mac地址，所以需要在界面中指定网卡的mac地址，或者直接修改ocml中生成的xml文件，添加mac信息。</p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../VMware-vmx转换/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../VMware-vmx转换/" class="btn btn-xs btn-link">
        VMware-vmx转换
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../virt-p2v磁盘转换流程/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../virt-p2v磁盘转换流程/" class="btn btn-xs btn-link">
        virt-p2v磁盘转换流程
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content">
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>