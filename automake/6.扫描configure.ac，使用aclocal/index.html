<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="shihr">
    
    <link rel="shortcut icon" href="../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>6.扫描configure.ac，使用aclocal - Work Sink</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "6.1 \u914d\u7f6e\u8981\u6c42", url: "#_top", children: [
          ]},
          {title: "6.3 \u81ea\u52a8\u751f\u6210aclocal.m4", url: "#63-aclocalm4", children: [
              {title: "6.3.1 aclocal\u63a5\u53d7\u7684\u4e00\u4e9b\u9009\u9879\u3002", url: "#631-aclocal" },
              {title: "6.3.2 \u5b8f\u641c\u7d22\u8def\u5f84", url: "#632" },
              {title: "6.3.3 \u7f16\u5199\u81ea\u5df1\u7684aclocal\u5b8f", url: "#633-aclocal" },
              {title: "6.3.4 \u5904\u7406\u672c\u5730\u5b8f", url: "#634" },
              {title: "6.3.5 \u7f16\u53f7", url: "#635" },
              {title: "6.3.6 aclocal\u7684\u672a\u6765", url: "#636-aclocal" },
          ]},
          {title: "6.4 Automake\u63d0\u4f9b\u7684Autoconf\u5b8f", url: "#64-automakeautoconf", children: [
              {title: "\u516c\u5171\u5b8f", url: "#_1" },
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    <h2 id="61">6.1 配置要求</h2>
<p>唯一的要求就是在configure.ac文件中加上<code>AM_INIT_AUTOMAKE</code>宏。</p>
<p>下面是几个Automake要求的但是不会被<code>AM_INIT_AUTOMAKE</code>运行的宏</p>
<ul>
<li>AC_CONFIG_FILES</li>
<li>AC_OUTPUT
    这两个经常在末尾被调用，指明了哪些文件会被生成。如果以.am结尾则生成.in结尾的文件。不能识别shell变量，需要在<code>AC_SUBST</code>中注册，并且以<code>${xxx}</code>形式引用才可识别。</li>
</ul>
<pre><code class="make">    AC_SUBST([APIVERSION], …)
    …
    AC_CONFIG_FILES(
      [tests/aclocal-${APIVERSION}:tests/aclocal.in],
      [chmod +x tests/aclocal-${APIVERSION}],
      [APIVERSION=$APIVERSION])
    AC_CONFIG_FILES(
      [tests/automake-${APIVERSION}:tests/automake.in],
      [chmod +x tests/automake-${APIVERSION}])
</code></pre>

<ul>
<li>等等...</li>
</ul>
<h2 id="63-aclocalm4">6.3 自动生成aclocal.m4</h2>
<p>一些宏必须被定义在aclocal.m4中，否则autoconf不会找到他们。</p>
<p>aclocal可以根据configure.ac生成aclocal.m4。首先aclocal扫描所有的.m4文件搜集宏定义，然后扫描configure.ac，所有在第一步找到的宏及其依赖的宏都会被放在aclocal.m4文件中。如果本地没有找到就会在系统层面的目录中寻找。</p>
<p>通常宏放到aclocal.m4中是通过复制整个文件内容来完成的。但是通过命令参数<code>-I</code>来指定相对路径时，使用<code>m4_include</code>代替复制它到aclocal.m4文件中；指定绝对路径时或者是系统层面的目录时，会直接复制过来。故最好使用<code>-I `pwd`/reldir</code>代替<code>-I reldir</code>。</p>
<p>acinclude.m4也会被指定放到aclocal.m4文件中，建议不要在新包中使用该文件。</p>
<p>操作aclocal.m4时，aclocal运行<code>autom4te</code> (see <a href="http://www.gnu.org/software/autoconf/manual/autoconf.html#Using-autom4te">Using Autom4te</a> in The Autoconf Manual) 追踪哪些宏被真正的使用了。autom4e也要存在于PATH环境变量中。</p>
<h3 id="631-aclocal">6.3.1 aclocal接受的一些选项。</h3>
<p>比较重要的两个选项</p>
<p>-I dir</p>
<pre><code>Add the directory dir to the list of directories searched for .m4 files.
</code></pre>
<p>--install</p>
<pre><code>Install system-wide third-party macros into the first directory specified with ‘-I dir’ instead of copying them in the output file. Note that this will happen also if dir is an absolute path.

When this option is used, and only when this option is used, aclocal will also honor ‘#serial number’ lines that appear in macros: an M4 file is ignored if there exists another M4 file with the same basename and a greater serial number in the search path (see Serials).
</code></pre>
<h3 id="632">6.3.2 宏搜索路径</h3>
<p>默认的搜索路径及顺序:
- acdir-APIVERSION      APIVERSION取决于Automake的版本
- acdir     此目录适用于第三方.m4文件，automake构建时被配置。通常被配置为${prefix}/share/aclocal/</p>
<p>修改搜素路径方式一：
<code>-I dir1 -I dir2</code>
把会dir加到默认的前面：<code>dir1 -&gt; dir2 -&gt; 默认路径</code></p>
<p>修改搜素路径方式二：
dirlist</p>
<p>修改搜素路径方式三：
ACLOCAL_PATH</p>
<h3 id="633-aclocal">6.3.3 编写自己的aclocal宏</h3>
<p>这个技术可以被用于想要支持自己的Autoconf宏被其它程序使用的库（This can be used by libraries that want to supply their own Autoconf macros for use by other programs）。比如，gettext库支持AM_GNU_GETTEXT宏被用于任何使用gettext的包。库安装之后，其宏也被安装，这样aclocal就能找到它。</p>
<p>A macro file’s name should end in .m4. Such files should be installed in $(datadir)/aclocal. This is as simple as writing: </p>
<pre><code>aclocaldir = $(datadir)/aclocal
aclocal_DATA = mymacro.m4 myothermacro.m4
</code></pre>
<p>宏文件应该由一系列的<code>quoted AC_DEFUN</code>(see <a href="http://www.gnu.org/software/autoconf/manual/autoconf.html#Macro-Definitions">Macro Definitions</a> in The Autoconf Manual)组成。</p>
<h3 id="634">6.3.4 处理本地宏</h3>
<p>Autoconf提供的功能测试不能满足所有的需求。人们需要用自己的宏或者第三方宏补充现有的测试。有以下两种方式：</p>
<ul>
<li>在acinclude.m4中列出你所有的宏</li>
<li>（推荐方法）将每个宏写到自己的文件中然后放到一个目录中（通常是m4），然后在configure.ac中添加变量：<code>AC_CONFIG_MACRO_DIRS([m4])</code>。第三方的宏文件最好也放到这个目录下。</li>
</ul>
<p>aclocal提供了<code>--install</code>选项来复制系统层面的宏到你本地的宏目录，帮助你解决上面的问题。本地的宏比系统层面的宏有优先权。推荐在每次运行aclocal时使用<code>--install</code>选项。</p>
<h3 id="635">6.3.5 编号</h3>
<p>为了区分一个宏的版本。
位于M4文件的宏定义的前面。
<code>#</code>必须是此行的第一个字符，允许在version之后添加其他字符</p>
<pre><code class="make">    #serial version garbage
</code></pre>

<p>使用了alcohol的--install选项的话，aclocal会选择含有#serial的或者编号比较新的那个文件。此编号对应的是整个文件，而不是单一的一个宏。</p>
<h3 id="636-aclocal">6.3.6 aclocal的未来</h3>
<p>aclocal可能会消失。因为处理M4的宏是Autoconf的任务。</p>
<p>永远不要自己调用aclocal，让它处于autoreconf和Automake的构建规则的控制下。</p>
<p>很多包含有bootstrap或者autogen.sh脚本，实际上他们只是安照正确的顺序调用命令（aclocal, libtoolize, gettextize or autopoint, autoconf, autoheader, and automake），这些工作autoreconf就可以做到。</p>
<h2 id="64-automakeautoconf">6.4 Automake提供的Autoconf宏</h2>
<p>• Public Macros:        Macros that you can use.
• Obsolete Macros:      Macros that will soon be removed.
• Private Macros:       Macros that you should not use. </p>
<h3 id="_1">公共宏</h3>
<h4 id="am_init_automake-options">AM_INIT_AUTOMAKE ([options])</h4>
<p>使用空格分隔的automake选项。</p>
<pre><code>    AM_INIT_AUTOMAKE([-Wno-portability])
</code></pre>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../7.文件夹/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../7.文件夹/" class="btn btn-xs btn-link">
        7.文件夹
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../5.创建Makefile.in/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../5.创建Makefile.in/" class="btn btn-xs btn-link">
        5.创建Makefile.in
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content">
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>