<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="shihr">
    
    <link rel="shortcut icon" href="../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>15.测试套件的支持 - Sink</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "15.2 \u7b80\u5355\u6d4b\u8bd5", url: "#_top", children: [
              {title: "15.2.1 \u57fa\u4e8e\u811a\u672c\u7684\u6d4b\u8bd5\u5957\u4ef6", url: "#1521" },
              {title: "15.2.2 \u4e32\u884c\u6d4b\u8bd5", url: "#1522" },
              {title: "15.2.3 \u5e76\u884c\u6d4b\u8bd5", url: "#1523" },
          ]},
          {title: "15.3 \u81ea\u5b9a\u4e49\u6d4b\u8bd5\u9a71\u52a8\u7a0b\u5e8f", url: "#153", children: [
              {title: "15.3.1 \u6982\u8ff0", url: "#1531" },
              {title: "15.3.2 \u58f0\u660e\u9a71\u52a8", url: "#1532" },
              {title: "15.3.3 \u5b9a\u5236\u6d4b\u8bd5\u9a71\u52a8\u7684 API", url: "#1533-api" },
          ]},
          {title: "15.4 TAP \u6d4b\u8bd5\u534f\u8bae", url: "#154-tap", children: [
              {title: "15.4.1 \u4ecb\u7ecd", url: "#1541" },
              {title: "15.4.2 \u7ed3\u5408Automake\u6d4b\u8bd5\u5de5\u5177\u4f7f\u7528", url: "#1542-automake" },
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../18.规则杂项/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../18.规则杂项/" class="btn btn-xs btn-link">
        18.规则杂项
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../14.发布/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../14.发布/" class="btn btn-xs btn-link">
        14.发布
      </a>
    </div>
    
  </div>

    

    <p>测试套件由一系列的测试用例组成。</p>
<p>Automake可以生成代码来处理两种测试套件。</p>
<ol>
<li>基于和<code>dejagnu</code>框架集成。</li>
<li>基于通用测试脚本，通过定义特殊变量<code>TESTS</code>激活。好像不支持通配符。</li>
</ol>
<p>第二种允许并发执行测试脚本，使用已有的测试协议（例如TAP），以及自定义测试驱动程序和测试运行程序。</p>
<p>在任何情况下，通过<code>make check</code>调用测试套件。</p>
<p>一些说明：</p>
<p>跳过测试（<em>skipped</em>）：测试没有意义，测试条件不满足。</p>
<p>硬错误（<em>hard error</em>）：测试场景不对，一些意外情况。</p>
<p>预期失败<em>expected failure (xfail)</em>，未预计的通过<em>unexpected pass (xpass)</em>。</p>
<h2 id="152">15.2 简单测试</h2>
<h3 id="1521">15.2.1 基于脚本的测试套件</h3>
<p>如果<code>TESTS</code>变量被定义了，其值是执行测试的程序或脚本列表。</p>
<p>测试脚本可以并行或串行执行，默认的是并行测试套件。
默认的测试结果是测试脚本的退出结果。</p>
<p>Automake也支持更多的协议：standard (see <a href="https://www.gnu.org/software/automake/manual/automake.html#Using-the-TAP-test-protocol">Using the TAP test protocol</a>) 和 custom (see <a href="https://www.gnu.org/software/automake/manual/automake.html#Custom-Test-Drivers">Custom Test Drivers</a>)。</p>
<p><em>note</em>：不能在串行中使用这些协议。</p>
<p>不使用测试协议的时候，测试脚本的退出码的意义如下：</p>
<ul>
<li>0 - 成功</li>
<li>77 - 跳过该测试</li>
<li>99 - 硬错误</li>
<li>其它 - 失败</li>
</ul>
<p>可以使用<code>XFAIL_TESTS</code>变量列出<em>xfail</em>的测试，它是<code>TESTS</code>的子集。定义<code>DISABLE_HARD_ERRORS</code>变量为非空值来项普通的错误一样对待硬错误。</p>
<p><em>note</em>：使用测试协议的时候，这两个变量不会起作用。</p>
<pre><code>PASS: foo.sh
PASS: zardoz.tap 1 - Daemon started
PASS: zardoz.tap 2 - Daemon responding
SKIP: zardoz.tap 3 - Daemon uses /proc # SKIP /proc is not mounted
PASS: zardoz.tap 4 - Daemon stopped
SKIP: bar.sh
PASS: mu.tap 1
XFAIL: mu.tap 2 # TODO frobnication not yet implemented
</code></pre>

<p><code>AM_COLOR_TESTS=always</code>，彩色输出。</p>
<p><code>AM_TESTS_ENVIRONMENT</code> 与 <code>TESTS_ENVIRONMENT</code>变量用于给测试脚本运行初始化代码和设置环境变量。前者是开发人员保留的，后者是用户保留的（可扩展并且覆盖前者的设置）。非空的<code>AM_TESTS_ENVIRONMENT</code>必须以分号结束，且不支持串行测试。</p>
<p>Automake会保证每个在<code>TEST</code>中列出的文件在运行之前被构建。</p>
<p>在<code>check_primary</code>中列出的测试程序之在<code>make check</code>的时候构建，而不是在<code>make all</code>期间。</p>
<h3 id="1522">15.2.2 串行测试</h3>
<p><strong>强烈不推荐使用。</strong></p>
<p>通过Automake选项<em>serial-tests</em>实现串行测试</p>
<h3 id="1523">15.2.3 并行测试</h3>
<p><em>make -j</em>执行并行测试。</p>
<pre><code class="shell">make -j3 check
</code></pre>

<p>标准错误与标准输出重定向到每个测试的<code>.log</code>文件，结果在<code>.trs</code>文件。失败的测试收集在<em>test-suite.log</em>文件中。</p>
<p>自定义测试程序；没有注册的扩展名的测试，会使用变量<code>LOG_COMPILER, AM_LOG_FLAGS, and LOG_FLAGS</code>：</p>
<pre><code>TESTS = foo.pl bar.py baz
TEST_EXTENSIONS = .pl .py
PL_LOG_COMPILER = $(PERL)
AM_PL_LOG_FLAGS = -w
PY_LOG_COMPILER = $(PYTHON)
AM_PY_LOG_FLAGS = -v
LOG_COMPILER = ./wrapper-script
AM_LOG_FLAGS = -d
</code></pre>

<p>可以使用<code>:</code>来保证测试的依赖关系</p>
<pre><code>TESTS = foo-compile.test foo-execute.test
foo-execute.log: foo-compile.log
</code></pre>

<p><em>note</em>：只保证顺序，不保证结果。即无论foo-compile.test是否成功，都会继续执行foo-execute.log。</p>
<h2 id="153">15.3 自定义测试驱动程序</h2>
<h3 id="1531">15.3.1 概述</h3>
<p>自定义的测试程序的预期是：正确地运行传递给它的测试程序（包括命令行传递给测试程序的参数），分析它们的执行和结果，创建相关的<code>.log</code>和<code>.trs</code>文件，在控制台显示测试结果。</p>
<p>如何确定和分析测试脚本结果的确切细节由各个驱动程序决定。</p>
<p>即使使用自定义的测试驱动程序，并行测试的大部分功能仍然要实现；包括以下几点：</p>
<ul>
<li>在<code>TESTS</code>中定义测试脚本，并在运行时可通过<code>TESTS</code>或<code>TEST_LOGS</code>覆盖。</li>
<li>通过使用make的选项-j<em>N</em>，并发执行。</li>
<li>每个测试的<code>.log</code>、<code>.trs</code>文件，还有摘要的<code>.log</code>文件。</li>
<li><code>recheck</code>目标，<code>RECHECK_LOGS</code>变量，测试懒重新运行。</li>
<li>测试间的依赖关系。</li>
<li>对<code>check_*</code>变量的支持（check_PROGRAMS, check_LIBRARIES, ...）。</li>
<li>使用<code>VERBOSE</code>环境变量获取测试套件失败的详细输出。</li>
<li>定义<code>TESTS_ENVIRONMENT, AM_TESTS_ENVIRONMENT and AM_TESTS_FD_REDIRECT</code>变量。</li>
<li>通用定义和扩展定义<code>LOG_COMPILER</code>和<code>LOG_FLAGS</code>变量。</li>
</ul>
<h3 id="1532">15.3.2 声明驱动</h3>
<p>通过定义make变量<code>LOG_DRIVER</code>或<code>ext_LOG_DRIVER</code>（<em>ext</em>必须在<code>TEST_EXTENSIONS</code>中声明）来声明自定义的测试套件驱动。</p>
<p>开发者保留变量<code>AM_DRIVER_FLAGS</code>和用户保留变量<code>LOG_DRIVER_FLAGS</code>可被用于定义<em>flags</em>，会被传给每个<code>LOG_DRIVER</code>调用。类似的，对于每个在<code>TEST_EXTENSIONS</code>中声明的扩展<em>ext</em>，在<code>AM_ext_LOG_DRIVER_FLAGS</code>和<code>ext_LOG_DRIVER_FLAGS</code>中列出的<em>flags</em>会被传递给<code>ext_LOG_DRIVER</code>。</p>
<h3 id="1533-api">15.3.3 定制测试驱动的 API</h3>
<p>pass</p>
<h2 id="154-tap">15.4 TAP 测试协议</h2>
<h3 id="1541">15.4.1 介绍</h3>
<p>TAP， the Test Anything Protocol，是一个简单的基于文本的在测试模块（或程序）与测试工具之间的接口。
 The tests (TAP producers) 向标准输出中以一种简单的格式写入测试结果； a test harness (TAP consumer)会解析和解释这些结果，正确地呈现给用户，并且/或者为稍后的分析注册结果。</p>
<h3 id="1542-automake">15.4.2 结合Automake测试工具使用</h3>
<p>目前Automake附带的TAP驱动程序需要一些手动配置。必须从Automake的发行版中获取<code>tap-driver.sh</code>脚本，复制到源码目录，然后使用Automake支持的第三方测试驱动来指导工具俩使用该脚本和<code>AM_INIT_AUTOMAKE</code>发现的awk程序来运行自己的<em>TAP-producing</em>测试。</p>
<p>除了通用的Automake测试驱动选项，<code>tap-driver.sh</code>还支持以下选项：</p>
<ul>
<li>--ignore-exit 忽视测试脚本的退出状态；默认情况下，如果脚本以非零状态退出，驱动会报告一个错误。</li>
<li>--comments 指示测试驱动程序在测试套件的输出也显示TAP注释（即以<code>#</code>开头的行）。默认情况下，注释只会复制到<code>.log</code>文件。</li>
<li>--no-comments</li>
<li>--merge 指示测试驱动合并测试脚本的标准错误到他们的标准输出。如果你想保证测试脚本中的注释与测试结果一起显示，该选项是必须的。</li>
<li>--no-merge</li>
<li>--diagnostic-string=STRING 改变注释的符号：<code>#</code>-&gt;<code>STRING</code>。非TAP官方标准。</li>
</ul>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../18.规则杂项/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../18.规则杂项/" class="btn btn-xs btn-link">
        18.规则杂项
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../14.发布/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../14.发布/" class="btn btn-xs btn-link">
        14.发布
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content">
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>