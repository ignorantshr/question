<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="shihr">
    
    <link rel="shortcut icon" href="../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>8.构建程序和库 - Work Sink</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "8.1 \u6784\u5efa\u4e00\u4e2a\u7a0b\u5e8f", url: "#_top", children: [
              {title: "8.1.1 \u5b9a\u4e49\u7a0b\u5e8f\u6e90", url: "#811" },
              {title: "8.1.2 \u94fe\u63a5\u7a0b\u5e8f", url: "#812" },
              {title: "8.1.3 \u6e90\u6587\u4ef6\u7684\u6761\u4ef6\u7f16\u8bd1", url: "#813" },
              {title: "8.1.3 \u7a0b\u5e8f\u7684\u6761\u4ef6\u7f16\u8bd1", url: "#813_1" },
          ]},
          {title: "8.4 \u7a0b\u5e8f\u4e0e\u5e93 \u7684\u53d8\u91cf", url: "#84", children: [
          ]},
          {title: "8.5 \u9ed8\u8ba4\u7684 _SOURCES", url: "#85-_sources", children: [
          ]},
          {title: "8.20 \u53ef\u6267\u884c\u6269\u5c55\u7684\u652f\u6301", url: "#820", children: [
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    <h2 id="81">8.1 构建一个程序</h2>
<p>为了构建一个程序，需要告知Automake哪些源是它的一部分，和它应该链接哪些库。</p>
<h3 id="811">8.1.1 定义程序源</h3>
<p>在一个包含了要被构建进程序的资源（非库或脚本）的文件夹，使用<code>PROGRAMS</code>。</p>
<p>程序可以被安装到<code>bindir, sbindir, libexecdir, pkglibexecdir</code>，或者根本不安装(noinst_)，或者只在<code>make check</code>的时候构建（check_）。</p>
<pre><code>bin_PROGRAMS = hello
</code></pre>

<p>与每个程序相关联的是以程序命名的几个辅助变量。这些变量是可选的，并且有合理的默认值。下面以hello为例做出说明。</p>
<p>hello_SOURCES 用于指定哪些源文件被构建进入一个可执行文件：</p>
<pre><code>hello_SOURCES = hello.c version.c getopt.c getopt1.c getopt.h system.h
</code></pre>

<p>改变量的默认变量是单个文件<code>hello.c</code>。</p>
<p>一个文件夹可以构建多个程序。多个程序也可以共享一个单个的源文件。</p>
<h3 id="812">8.1.2 链接程序</h3>
<p>如果你想链接没有被configure发现的库，使用<code>LDADD</code>变量，链接标志则使用<code>AM_LDFLAGS</code>变量。</p>
<p>有时，多个程序在一个目录下构建，但是链接需求不同。这种情况下，可以使用 <em>prog</em>_LDADD 变量来覆盖<code>LDADD</code>。</p>
<p>例如，cpio、pax、mt 与库文件 libcpio.a 链接，但是同一个目录下还有另一个程序 rmt 被构建，它不需要这个库文件。并且，mt 和 rmt 只会在特定架构下被构建。下面是 cpio 的src/Makefile.am 文件的写法：</p>
<pre><code class="make">    bin_PROGRAMS = cpio pax $(MT)
    libexec_PROGRAMS = $(RMT)
    EXTRA_PROGRAMS = mt rmt

    LDADD = ../lib/libcpio.a $(INTLLIBS)
    rmt_LDADD =

    cpio_SOURCES = …
    pax_SOURCES = …
    mt_SOURCES = …
    rmt_SOURCES = …
</code></pre>

<p>使用变量 <em>prog</em>_LDFLAGS 传递链接标志。</p>
<h3 id="813">8.1.3 源文件的条件编译</h3>
<p>你不能放置一个配置替换（e.g., ‘@FOO@’ or ‘$(FOO)’ where FOO is defined via AC_SUBST）到<code>_SOURCES</code>变量中。
但是有两个方法可以达到同样的目的：1、在<code>_LDADD</code>中使用配置替换；2、使用Automake的条件语句。</p>
<h5 id="1_ldadd">1.使用<code>_LDADD</code></h5>
<p>Automake必须知道所有的可能用到的源文件。任何条件构建的文件都应放到合适的<code>EXTRA_</code>变量中。</p>
<p>例如，相要 hello-linux.c 或 hello-generic.c 有条件地构建到 hello 中：</p>
<pre><code>Makefile.am：
    bin_PROGRAMS = hello
    hello_SOURCES = hello-common.c
    EXTRA_hello_SOURCES = hello-linux.c hello-generic.c
    hello_LDADD = $(HELLO_SYSTEM)
    hello_DEPENDENCIES = $(HELLO_SYSTEM)

configure.ac：
    case $host in
      *linux*) HELLO_SYSTEM='hello-linux.$(OBJEXT)' ;;
      *)       HELLO_SYSTEM='hello-generic.$(OBJEXT)' ;;
    esac
    AC_SUBST([HELLO_SYSTEM])
</code></pre>

<p>hello_DEPENDENCIES and hello_LDADD保证了构建和链接。</p>
<h4 id="2automake">2.使用Automake的条件语句</h4>
<p>这种方式更简单。还是上述的例子：</p>
<pre><code>Makefile.am：
    bin_PROGRAMS = hello
    hello_SOURCES = hello-common.c
    if LINUX
    hello_SOURCES += hello-linux.c
    else
    hello_SOURCES += hello-generic.c
    endif

configure.ac：
    AM_CONDITIONAL([LINUX],[
        case $host in
          *linux*) HELLO_SYSTEM='hello-linux.$(OBJEXT)' ;;
          *)       HELLO_SYSTEM='hello-generic.$(OBJEXT)' ;;
        esac
    ])
</code></pre>

<p>你不需要定义<code>EXTRA_</code>变量。</p>
<h3 id="813_1">8.1.3 程序的条件编译</h3>
<p><code>_PROGRAMS</code>同样可以使用 <code>替换或条件语句</code> 来实现目的。</p>
<h4 id="1configure">1.使用configure来替换</h4>
<pre><code>bin_PROGRAMS = cpio pax $(MT)
libexec_PROGRAMS = $(RMT)
EXTRA_PROGRAMS = mt rmt
</code></pre>

<p><em>note</em>：As explained in <a href="https://www.gnu.org/software/automake/manual/automake.html#EXEEXT">EXEEXT</a>, Automake will rewrite bin_PROGRAMS, libexec_PROGRAMS, and EXTRA_PROGRAMS, appending ‘$(EXEEXT)’ to each binary.
但是如果使用了变量替换，则不会扩展后缀。</p>
<h4 id="2">2.使用条件语句</h4>
<pre><code>bin_PROGRAMS = cpio pax
if WANT_MT
  bin_PROGRAMS += mt
endif
if WANT_RMT
  libexec_PROGRAMS = rmt
endif
</code></pre>

<p>这种方式不必担心 ‘$(EXEEXT)’ or EXTRA_PROGRAMS。</p>
<h2 id="84">8.4 程序与库 的变量</h2>
<p>有一组变量和每个程序相关，可用于修改程序的构建方式。库也类似。它们的名字呗用于命名这些变量的基础。</p>
<p>下面，我使用名字<code>maude</code>代表程序或者库来说明这些变量。</p>
<ul>
<li>maude_SOURCES </li>
<li>EXTRA_maude_SOURCES </li>
<li>maude_LDADD </li>
<li>maude_LDFLAGS</li>
<li>maude_DEPENDENCIES </li>
<li>EXTRA_maude_DEPENDENCIES </li>
</ul>
<h2 id="85-_sources">8.5 默认的 _SOURCES</h2>
<p>_SOURCES variables are used to specify source files of programs (<a href="https://www.gnu.org/software/automake/manual/automake.html#A-Program">see A Program</a>), libraries (<a href="https://www.gnu.org/software/automake/manual/automake.html#A-Library">see A Library</a>), and Libtool libraries (<a href="https://www.gnu.org/software/automake/manual/automake.html#A-Shared-Library">see A Shared Library</a>). </p>
<p>该变量没有被指定的时候，默认值是单个的同名 C文件 ，带有任何被<code>AM_DEFAULT_SOURCE_EXT</code>替换的后缀，默认的后缀是<code>.c</code>。</p>
<pre><code>check_PROGRAMS = test1 test2 test3
AM_DEFAULT_SOURCE_EXT = .cpp
</code></pre>

<h2 id="820">8.20 可执行扩展的支持</h2>
<p>在一些平台，比如windows，可执行程序会被扩展成含有.exe的程序。</p>
<p>Automake支持大部分这种转换。</p>
<p>One thing you must be aware of is that, internally, Automake rewrites something like this:</p>
<pre><code>bin_PROGRAMS = liver
</code></pre>

<p>to this:</p>
<pre><code>bin_PROGRAMS = liver$(EXEEXT)
</code></pre>

<p><code>TESTS and XFAIL_TESTS</code>也会被重写如果在同一个Makefile中他们包含了已经被声明为程序的文件名。</p>
<p>但是，这个技术不能应用于configure变量替换。这意味着如果你使用了条件构建，那么你必须自己在configure.ac中添加<code>$(EXEEXT)</code>扩展其后缀。</p>
<p><code>no-exeext</code>选项可以关闭这个特性，它会覆盖<code>foo$(EXEEXT)</code>规则。</p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../9.其它派生对象/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../9.其它派生对象/" class="btn btn-xs btn-link">
        9.其它派生对象
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../7.文件夹/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../7.文件夹/" class="btn btn-xs btn-link">
        7.文件夹
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content">
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>