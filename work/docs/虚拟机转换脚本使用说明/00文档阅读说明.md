# 1. 文档的目的

本文档说明的是**虚拟机转换脚本**的使用。该脚本位于`shell/convert.sh`。

该脚本的目的是将`VMware平台及Xen虚拟化平台`的虚拟机转换到`ovirt或ACloudAge KS`平台。

# 2. 搭建转换服务器

执行转换脚本的服务器称作`转换服务器`。

在使用该脚本之前，请首先阅读[转换服务器的搭建](转换服务器的搭建.md)为脚本提供必要的运行环境，并查看本文**4.注意事项**章节。

# 3. 脚本的使用说明

脚本在命令行按以下格式执行：

```bash
convert 输入选项 输出选项
```

将`输入选项`与`输出选项`补充完整后才可执行命令，如何填写参考下方的构造说明，你也可以执行`convert --help`查阅简单的使用说明。

#### 输入选项的构造

脚本支持6种输入模式，每种都有对应的如何构造输入选项的说明文档：

|  模式   |                    模式说明                    |              对应的说明文档               |
| :-----: | :--------------------------------------------: | :---------------------------------------: |
|   ova   | 利用VMware平台的虚拟机ova文件进行虚拟机转换。  |     [1.ova转换模式](1.ova转换模式.md)     |
|   vmx   | 利用VMware平台的虚拟机工作目录进行虚拟机转换。 |     [2.vmx转换模式](2.vmx转换模式.md)     |
|  ESXi   |        通过访问ESXi服务器来转换虚拟机。        |    [3.ESXi转换模式](3.ESXi转换模式.md)    |
| vCenter |  通过访问VMware vCenter服务器进行虚拟机转换。  | [4.vCenter转换模式](4.vCenter转换模式.md) |
|  vddk   |     通过VMware的开发库vddk进行虚拟机转换。     |    [5.vddk转换模式](5.vddk转换模式.md)    |
|   xen   |         从xen虚拟化平台上转换虚拟机。          |     [6.xen转换模式](6.xen转换模式.md)     |

#### 输出选项的构造

输出选项的构造则参考[转换到ovirt平台](转换到ovirt平台.md)。



#### 举例说明

转换场景：想要转换VMware Workstation上的一台虚拟机到ovirt平台。

首先通过上述的构造输入选项的参考文档`1.ova转换模式`获取了一台虚拟机的ova文件（centos.ova），并构造了输入选项：

```shell
--mode ova --file centos.ova
```

然后通过上述的构造输出选项的参考文档`转换到ovirt平台`构造了输出选项：

```shell
--export-path 172.16.2.124:/home/exports
```

此时，就可以在转换服务器上面执行命令转换虚拟机：

```shell
convert --mode ova --file centos.ova --export-path 172.16.2.124:/home/exports
```



# 4. 注意事项

- 支持转换的虚拟机的操作系统有以下几种：

    - Red Hat Enterprise Linux 3, 4, 5, 6, 7
    - CentOS 3, 4, 5, 6, 7 
    - Scientific Linux 3, 4, 5, 6, 7 
    - Oracle Linux
    - Fedora  
    - SLES 10 及以上
    - OpenSUSE 10 及以上
    - Debian 6 及以上
    - Ubuntu 10.04, 12.04, 14.04, 16.04, 及以上
    - Windows XP 到 Windows 10 / Windows Server 2016

- 在转换之前虚拟机必须是**关机状态**。

- 使用之前根据需要搭建VMware的服务器或xen的虚拟化服务器。

- 所有的VMware平台的Windows虚拟机在转换之前都需要先卸载`VMware-tools`。

- 如果Windows虚拟机开启了`快速启动`的功能，那么需要关闭该功能。否则会出现如下字样的错误信息并转换失败：

    > guestfsd: error: mount exited with status 14: The disk contains an unclean file system (0, 0).
    > Metadata kept in Windows cache, refused to mount.

- 在转换过程中如果出现了类似`iPXE (http://ipxe.org) 00:05.0 C100 PCI2.10 PnP PMM`的字样并卡住不继续向下执行的情况，此时需要升级`qemu`的版本：

```shell
yum install centos-release-qemu-ev
yum install qemu-kvm qemu-img -y
```

