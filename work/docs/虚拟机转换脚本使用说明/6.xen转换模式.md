**目录**

[TOC]

从xen虚拟化平台上转换虚拟机。

可从以下xen版本的服务器转换虚拟机：`RHEL 5 Xen or SLES and openSUSE Xen hosts`。

# 1. 设置免密登录

在转换之前，需要对xen服务器设置免密登录。

首先启用xen服务器的SSH功能，然后添加转换服务器的公钥到xen服务器：

1. 在转换服务器上查看公钥：`cat ~/.ssh/id_rsa.pub`，没有的话先生成密钥对：`ssh-key-agent -t rsa`
2. 复制公钥并添加到xen服务器下的`~/.ssh/authorized_keys`文件中，没有的话先新建一个

3. 接着将私钥给`ssh-agent`托管：
    1. 在转换服务器上执行：`eval $(ssh-agent -s)`
    2. 在转换服务器上执行：`ssh-add`
    3. 从转换服务器通过ssh登录到xen服务器进行免密登录验证

在RHEL 5的版本，你可能需要执行下面的命令：

```shell
update-crypto-policies LEGACY
```

# 2. 构造URI

xen服务器需要URI来连接。

格式如下：

```shell
xen+ssh://user@xen.example.com
```

- `xen+ssh`：固定参数，表示使用xen和ssh链接
- `user`：登录到xen服务器的用户名
- `xen.example.com`：xen服务器的IP地址或域名。

# 3. 测试libvirt到xen的连接

在转换之前，首先确保该URI是有效的，使用`virsh`命令测试：

```shell
 $ virsh -c xen+ssh://root@xen.example.com list --all
  Id    Name                           State
 ----------------------------------------------------
  0     Domain-0                       running
  -     rhel49-x86_64-pv               shut off
```

如果能看到虚拟机列表，则进一步测试：

```shell
 $ virsh -c xen+ssh://root@xen.example.com dumpxml rhel49-x86_64-pv
 <domain type='xen'>
   <name>rhel49-x86_64-pv</name>
   [...]
 </domain>
```

如果成功输出配置文件信息，那么表示该URI可用。

**`警告`**：如果测试失败，那么虚拟机转换不会成功！

# 4. 构造输入选项

使用xen转换虚拟机时，转换脚本的支持的输入选项有下列几个：

- `--mode`：输入模式。此处应选 xen。
- `--uri`：URI链接。
- `--vm-name`：要转换的虚拟机名字。此虚拟机必须在测试URI连接结果的虚拟机列表中。
- `--block-device`：表示虚拟机的磁盘位于主机的块设备上面，**此时也要保证转换服务器执行脚本的目录下有足够的空间容纳虚拟机的磁盘**。只能用于xen转换模式。默认为false。

如何判断磁盘是否位于主机的块设备上面：

当你测试链接时，如果虚拟机配置文件信息包含如下字样：

```xml
  <disk type='block' device='disk'>
    ...
    <source dev='xxx'/>
```

那么就说明有磁盘位于主机的块设备上面，此时必须添加`--block-device`选项。

#### 举例说明：

现有一台使用xen作为虚拟化技术的服务器，IP地址为`172.16.7.54`，上面有一台虚拟机`ubuntu14.04`。

那么其URI为：

```shell
xen+ssh://172.16.7.54
```

接着测试URI链接：

```shell
$ virsh -c "xen+ssh://172.16.7.54" list --all
 Id    Name                           State
----------------------------------------------------
 0     Domain-0                       running
 -     ubuntu14.04                    shut off
```

进一步测试：

```shell
$ virsh -c "xen+ssh://172.16.7.54" dumpxml ubuntu14.04
<domain type='xen'>
  <name>ubuntu14.04</name>
	[...]
  <devices>
    <disk type='file' device='disk'>
      <driver name='qemu' type='raw'/>
      <source file='/var/lib/libvirt/images/ubuntu14.04.img'/>
      <target dev='xvda' bus='xen'/>
    </disk>
    <disk type='block' device='disk'>
      <source dev='/dev/vdb1'/>
      <target dev='xvdb' bus='xen'/>
    </disk>
    [...]
</domain>
```

发现有磁盘位于主机的块设备上，故需要添加`--block-device`输入选项。

那么输入选项构造为：

```shell
--mode xen --uri xen+ssh://172.16.7.54 --vm-name ubuntu14.04 --block-device
```

# 5. 转换到ovirt平台

参考：[转换到ovirt平台](转换到ovirt平台.md)

