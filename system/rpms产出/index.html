<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="shihr">
    
    <link rel="shortcut icon" href="../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>rpms产出 - Sink</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "first rsync, then cp iso", url: "#_top", children: [
          ]},
          {title: "get vdc-win.exe", url: "#get-vdc-winexe", children: [
              {title: "ks-release-packer.sh", url: "#ks-release-packersh" },
          ]},
          {title: "get modified rpms", url: "#get-modified-rpms", children: [
          ]},
          {title: "get last vms-iso", url: "#get-last-vms-iso", children: [
          ]},
          {title: "get vms-iso-rpms", url: "#get-vms-iso-rpms", children: [
          ]},
          {title: "get last vdc-iso", url: "#get-last-vdc-iso", children: [
          ]},
          {title: "get vdc-iso-rpms", url: "#get-vdc-iso-rpms", children: [
          ]},
          {title: "get last tools-iso", url: "#get-last-tools-iso", children: [
          ]},
          {title: "rm -rf ${version}_${date}", url: "#rm-rf-version_date", children: [
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../rsync配置/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../rsync配置/" class="btn btn-xs btn-link">
        rsync配置
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../epel源/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../epel源/" class="btn btn-xs btn-link">
        epel源
      </a>
    </div>
    
  </div>

    

    <p>rpms产出</p>
<p>vdc-refa:
    vdc-1.0.0-142.gitd62ccbc.refa.x86_64.rpm
    vdc-debuginfo-1.0.0-142.gitd62ccbc.refa.x86_64.rpm
    vdc-plugin-net-1.0.0-142.gitd62ccbc.refa.x86_64.rpm
    vdc-plugin-vpn-1.0.0-142.gitd62ccbc.refa.x86_64.rpm</p>
<p>vdc-zhgf:
    vdc-1.0.0-29.gitdefba2a.zhgf.x86_64.rpm
    vdc-debuginfo-1.0.0-29.gitdefba2a.zhgf.x86_64.rpm</p>
<p>vdc-sec-2.5.10
    vdc-1.0.0-194.git7cb4d66.sec.x86_64.rpm
    vdc-debuginfo-1.0.0-194.git7cb4d66.sec.x86_64.rpm
    vdc-plugin-net-1.0.0-194.git7cb4d66.sec.x86_64.rpm
    vdc-plugin-vpn-1.0.0-194.git7cb4d66.sec.x86_64.rpm</p>
<p>rpms:
vms-sec-2.5.9</p>
<p>vms-sec-sec-2.5.9/ovirt-engine
vms-sec-sec-2.5.9/ovirt-engine-api
vms-sec-sec-2.5.9/ovirt-engine-audit-portal
vms-sec-sec-2.5.9/ovirt-engine-backend
vms-sec-sec-2.5.9/ovirt-engine-dbscripts
vms-sec-sec-2.5.9/ovirt-engine-extend-portal
vms-sec-sec-2.5.9/ovirt-engine-lib
vms-sec-sec-2.5.9/ovirt-engine-secrecy-portal
vms-sec-sec-2.5.9/ovirt-engine-setup-base
vms-sec-sec-2.5.9/ovirt-engine-setup-plugin-ovirt-engine
vms-sec-sec-2.5.9/ovirt-engine-setup-plugin-ovirt-engine-common
vms-sec-sec-2.5.9/ovirt-engine-setup-plugin-vmconsole-proxy-helper
vms-sec-sec-2.5.9/ovirt-engine-setup-plugin-websocket-proxy
vms-sec-sec-2.5.9/ovirt-engine-tools
vms-sec-sec-2.5.9/ovirt-engine-tools-backup
vms-sec-sec-2.5.9/ovirt-engine-vmconsole-proxy-helper
vms-sec-sec-2.5.9/ovirt-engine-webadmin-portal
vms-sec-sec-2.5.9/ovirt-engine-websocket-proxy
vms-sec-sec-2.5.9/ovirt-engine-dashboard
vdsm-sec/vdsm
vdsm-sec/vdsm-api
vdsm-sec/vdsm-cli
vdsm-sec/vdsm-hook-vmfex-dev
vdsm-sec/vdsm-infra
vdsm-sec/vdsm-jsonrpc
vdsm-sec/vdsm-python
vdsm-sec/vdsm-xmlrpc
vdsm-sec/vdsm-yajsonrpc
qemu-kvm-ev-sec/qemu-kvm-tools-ev
qemu-kvm-ev-sec/qemu-kvm-ev
qemu-kvm-ev-sec/qemu-kvm-common-ev
qemu-kvm-ev-sec/qemu-img-ev
ovirt-provider-ovn-sec/ovirt-provider-ovn-driver
ovirt-provider-ovn-sec/ovirt-provider-ovn
secretclient-sec/secretclient
ACloudAge-release-sec/ACloudAge-release
ovs-sec/openvswitch
ovs-sec/openvswitch-ovn-central
ovs-sec/openvswitch-ovn-common
ovs-sec/openvswitch-ovn-host
ovs-sec/python-openvswitch
tripwire-sec/tripwire
spice-html5-sec/spice-html5</p>
<p>vms-vgpu</p>
<p>vms-sec-vgpu/ovirt-engine
vms-sec-vgpu/ovirt-engine-api
vms-sec-vgpu/ovirt-engine-audit-portal
vms-sec-vgpu/ovirt-engine-backend
vms-sec-vgpu/ovirt-engine-dbscripts
vms-sec-vgpu/ovirt-engine-extend-portal
vms-sec-vgpu/ovirt-engine-lib
vms-sec-vgpu/ovirt-engine-secrecy-portal
vms-sec-vgpu/ovirt-engine-setup-base
vms-sec-vgpu/ovirt-engine-setup-plugin-ovirt-engine
vms-sec-vgpu/ovirt-engine-setup-plugin-ovirt-engine-common
vms-sec-vgpu/ovirt-engine-setup-plugin-vmconsole-proxy-helper
vms-sec-vgpu/ovirt-engine-setup-plugin-websocket-proxy
vms-sec-vgpu/ovirt-engine-tools
vms-sec-vgpu/ovirt-engine-tools-backup
vms-sec-vgpu/ovirt-engine-vmconsole-proxy-helper
vms-sec-vgpu/ovirt-engine-webadmin-portal
vms-sec-vgpu/ovirt-engine-websocket-proxy
vms-sec-sec-2.5.9/ovirt-engine-dashboard
vdsm-vgpu/vdsm
vdsm-vgpu/vdsm-api
vdsm-vgpu/vdsm-cli
vdsm-vgpu/vdsm-hook-vmfex-dev
vdsm-vgpu/vdsm-infra
vdsm-vgpu/vdsm-jsonrpc
vdsm-vgpu/vdsm-python
vdsm-vgpu/vdsm-xmlrpc
vdsm-vgpu/vdsm-yajsonrpc
qemu-kvm-2.6.0-sec/qemu-kvm-tools-ev
qemu-kvm-2.6.0-sec/qemu-kvm-ev
qemu-kvm-2.6.0-sec/qemu-kvm-common-ev
qemu-kvm-2.6.0-sec/qemu-img-ev
ovirt-provider-ovn-sec/ovirt-provider-ovn-driver
ovirt-provider-ovn-sec/ovirt-provider-ovn
secretclient-sec/secretclient
ACloudAge-release-sec/ACloudAge-release
ovs-sec/openvswitch
ovs-sec/openvswitch-ovn-central
ovs-sec/openvswitch-ovn-common
ovs-sec/openvswitch-ovn-host
ovs-sec/python-openvswitch
tripwire-sec/tripwire
spice-html5-sec/spice-html5</p>
<p>tools.iso打包</p>
<p>remote_isos_path=http://172.16.6.189/pub/iso_output/tools
iso_path=/home/pub/iso_output/tools
output_name=tools-test.iso
output_path=root@172.16.6.189:/home/pub/iso_output/vms
rsync_url=rsync://172.16.6.189/extras_tools
vdc_win=/home/pub/pkg_output/vdc-group/vdc-win/
branch_path=http://172.16.6.189/pub/pkg_output/vdc-group/vdc-win</p>
<p>isos=<code>ssh root@172.16.6.189 "ls --sort=time -r $iso_path"</code>
for iso in $isos
do
        real=$iso
done
echo ${real}
wget -P /tmp $remote_isos_path/$real
if [ $? -ne 0 ]; then
    echo "Failed to get iso!"
    exit 1
fi</p>
<p>mkdir /tmp/${output_name}.tmp
mount /tmp/$real /tmp/${output_name}.tmp
if [ $? -ne 0 ]; then
    echo "Failed to mount iso!"
    exit 1
fi</p>
<p>mkdir /tmp/$output_name
cd /tmp/$output_name</p>
<h1 id="first-rsync-then-cp-iso">first rsync, then cp iso</h1>
<p>rsync --delete -avrt $rsync_url  .
if [ $? -ne 0 ]; then
    echo "Failed to rsync iso base files!"
    exit 1
fi</p>
<p>cp -r /tmp/${output_name}.tmp/. /tmp/$output_name/
umount -v /tmp/${output_name}.tmp &amp;&amp; rm -rf /tmp/${output_name}.tmp &amp;&amp; rm -f /tmp/$real</p>
<h1 id="get-vdc-winexe">get vdc-win.exe</h1>
<p>branchs=<code>ssh root@172.16.6.189 "ls ${vdc_win}"</code>
for branch in $branchs
do
    exes=<code>ssh root@172.16.6.189 "ls --sort=time -r ${vdc_win}/${branch}/output/"</code>
    echo $exes
    for exe in $exes
    do
        real_exe=$exe
    done
    echo ${branch_path}/$branch/output/${real_exe}
    wget --quiet ${branch_path}/$branch/output/${real_exe}
done</p>
<p>mkisofs -J -rational-rock -full-iso9660-filenames -o ${output_name} .
if [ $? -ne 0 ]; then
    echo "Failed to make iso!"
    exit 1
fi</p>
<p>scp $output_name $output_path
rm -rf /tmp/$output_name/</p>
<h2 id="ks-release-packersh">ks-release-packer.sh</h2>
<p>version=v1.4
date=<code>date +%Y%m%d%H%M%S</code>
buildid=1
ssh_path=root@172.16.6.189
vms_iso_path=http://172.16.6.189/pub/iso_output/vms
vdc_iso_path=http://172.16.6.189/pub/iso_output/vdc
tools_iso_path=http://172.16.6.189/pub/iso_output/tools
remote_repo=root@172.16.6.189:/home/pub/release
modify_rpms=rpms.list</p>
<p>vms_iso_server_path=/home/pub${vms_iso_path#<em>pub}
vdc_iso_server_path=/home/pub${vdc_iso_path#</em>pub}
tools_iso_server_path=/home/pub${tools_iso_path#*pub}</p>
<p>mkdir ${version}<em>${date} &amp;&amp; cd ${version}</em>${date}
rpms=build_${date}_${buildid}.info
mkdir $rpms
mkdir -p packages/vms packages/vdc</p>
<h1 id="get-modified-rpms">get modified rpms</h1>
<p>OLD_IFS="$IFS"
for item in <code>cat ../${modify_rpms}</code>
do
    IFS="/"
    arr=($item)
    IFS="$OLD_IFS"
    prod=${arr[0]}
    repo=${arr[1]}
    name=${arr[2]}
    yum clean all --enablerepo=$repo
    yumdownloader --enablerepo=$repo --destdir=packages/${prod} $name
    if [ $? -ne 0 ]; then
        echo "Failed to get ${prod} package $name in $repo!"
        exit 1
    fi
done</p>
<h1 id="get-last-vms-iso">get last vms-iso</h1>
<p>vms_isos=<code>ssh ${ssh_path} "cd ${vms_iso_server_path} &amp;&amp; ls --sort=time -r *${version}*.iso"</code>
for vms_iso in ${vms_isos}
do
    vms_iso_real=$vms_iso
done
wget -O ACloudAge_KS_vms_${version}.iso ${vms_iso_path}/${vms_iso_real}</p>
<h1 id="get-vms-iso-rpms">get vms-iso-rpms</h1>
<p>vms_iso_main=${vms_iso_real%.iso}
wget -P ${rpms}/ ${vms_iso_path}/${vms_iso_main}-rpm.list</p>
<h1 id="get-last-vdc-iso">get last vdc-iso</h1>
<p>vdc_isos=<code>ssh ${ssh_path} "cd ${vdc_iso_server_path} &amp;&amp; ls --sort=time -r *${version}*.iso"</code>
for vdc_iso in ${vdc_isos}
do
    vdc_iso_real=$vdc_iso
done
wget -O ACloudAge_KS_vdc_${version}.iso ${vdc_iso_path}/${vdc_iso_real}</p>
<h1 id="get-vdc-iso-rpms">get vdc-iso-rpms</h1>
<p>vdc_iso_main=${vdc_iso_real%.iso}
wget -P ${rpms}/ ${vdc_iso_path}/${vdc_iso_main}-rpm.list</p>
<h1 id="get-last-tools-iso">get last tools-iso</h1>
<p>tools_isos=<code>ssh ${ssh_path} "cd ${tools_iso_server_path} &amp;&amp; ls --sort=time -r *${version}*.iso"</code>
for tools_iso in ${tools_isos}
do
    tools_iso_real=$tools_iso
done
wget -O ACloudAge_KS_tools_${version}.iso ${tools_iso_path}/${tools_iso_real}</p>
<p>cd ..
scp -r ${version}_${date} ${remote_repo}</p>
<h1 id="rm-rf-version_date">rm -rf ${version}_${date}</h1>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../rsync配置/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../rsync配置/" class="btn btn-xs btn-link">
        rsync配置
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../epel源/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../epel源/" class="btn btn-xs btn-link">
        epel源
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content">
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>